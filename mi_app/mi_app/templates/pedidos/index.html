{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-2">
  <!-- Cabecera con título y botones alineados a la izquierda -->
  <div class="d-flex align-items-center gap-2 flex-wrap mb-3">
    <h1 class="mb-0 me-2">
      <i class="fas fa-shopping-cart me-2"></i>Pedidos
    </h1>
    {% if pedidos %}
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#resumenPedidos" aria-expanded="false" aria-controls="resumenPedidos">
      <i class="fas fa-chart-bar me-1"></i>Mostrar resumen
    </button>
    {% endif %}
    <a href="{{ url_for('pedidos.nuevo') }}" class="btn btn-success">
      <i class="fas fa-plus me-1"></i>Nuevo Pedido
    </a>
    <a href="{{ url_for('pedidos.flujo_caja') }}" class="btn btn-info">
      <i class="fas fa-chart-line me-1"></i>Flujo de Caja
    </a>
    {% if is_superuser %}
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalEditarTasas">
      <i class="fas fa-edit me-1"></i>Editar Tasas
    </button>
    {% endif %}
  </div>

  <!-- Resumen de resultados (arriba, oculto tras botón) -->
  {% if pedidos %}
  <div class="mb-3">
    <div class="collapse" id="resumenPedidos">
      <div class="p-3 bg-light rounded">
        <div class="row text-center">
          <div class="col-md-2">
            <h6 class="text-muted">Total Pedidos</h6>
            <h4 class="text-primary">{{ pedidos|length }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Total BRS</h6>
            <h4 class="text-success">{{ pedidos|sum(attribute='brs')|format_int }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Total CLP</h6>
            <h4 class="text-info">{{ pedidos|sum(attribute='clp')|format_int }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Total Comisión</h6>
            <h4 class="text-danger">{{ total_comisiones|format_int }}</h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Barra horizontal de tasas estilo ticker -->
  <div class="rate-ticker border rounded px-3 py-2 mb-3">
    <div class="ticker-content d-inline-flex align-items-center gap-3">
      <span class="rate-item"><strong>Banesco</strong> <span class="text-success">{{ tasa_banesco }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Venezuela</strong> <span class="text-primary">{{ tasa_venezuela }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Otros</strong> <span class="text-warning">{{ tasa_otros }}</span></span>
      <!-- Duplicamos el contenido para un scroll continuo -->
      <span class="divider">|</span>
      <span class="rate-item"><strong>Banesco</strong> <span class="text-success">{{ tasa_banesco }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Venezuela</strong> <span class="text-primary">{{ tasa_venezuela }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Otros</strong> <span class="text-warning">{{ tasa_otros }}</span></span>
    </div>
  </div>
  <!-- Estilos del ticker se encuentran en static/css/styles.css -->

  <!-- Card que envuelve el formulario de filtrado y la tabla -->
  <div class="card shadow-lg">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="fas fa-filter me-1"></i>Filtros y Resultados
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- Columna izquierda: Formulario de Filtrado (más angosta) -->
        <div class="col-md-3">
          <form action="{{ url_for('pedidos.index') }}" method="get" id="filtro-form">
            <div class="mb-3">
              <label for="cliente_pedidos" class="form-label">
                <i class="fas fa-user me-1"></i>Cliente
              </label>
              <select name="cliente" id="cliente_pedidos" class="form-select">
                <option value="">Seleccione cliente</option>
                {% for client in cliente %}
                  <option value="{{ client }}" {% if client in request.args.getlist('cliente') %}selected{% endif %}>
                    {{ client }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="fecha" class="form-label">
                <i class="fas fa-calendar me-1"></i>Fecha
              </label>
              <input type="date" name="fecha" id="fecha" class="form-control" placeholder="Fecha (YYYY-MM-DD)" value="{{ request.args.get('fecha', current_date) }}">
            </div>
            <div class="mb-3">
              <label for="brs_display" class="form-label">
                <i class="fas fa-coins me-1"></i>BRS
              </label>
              <!-- Campo visible para el usuario -->
              <input type="text" id="brs_display" class="form-control" placeholder="BRS" value="{{ request.args.get('brs','') }}">
              <!-- Campo oculto real para el formulario -->
              <input type="hidden" id="brs" name="brs" value="{{ request.args.get('brs','') }}">
            </div>
            <div class="mb-3">
              <label for="clp_display" class="form-label">
                <i class="fas fa-calculator me-1"></i>CLP
              </label>
              <!-- Campo visible para el usuario -->
              <input type="text" id="clp_display" class="form-control" placeholder="CLP" value="{{ request.args.get('clp','') }}">
              <!-- Campo oculto real para el formulario -->
              <input type="hidden" id="clp" name="clp" value="{{ request.args.get('clp','') }}">
            </div>
            <div class="mb-3">
              <label for="cuenta_pedidos" class="form-label">
                <i class="fas fa-university me-1"></i>Cuenta Corriente
              </label>
              <select name="cuenta_id" id="cuenta_pedidos" class="form-select">
                <option value="">Todas las cuentas</option>
                {% for cuenta in cuentas_activas %}
                  <option value="{{ cuenta.id }}" {% if cuenta.id|string == request.args.get('cuenta_id', '') %}selected{% endif %}>
                    {{ cuenta.numero_cuenta }} - {{ cuenta.nombre_titular }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>Filtrar
              </button>
            </div>
            <div class="mb-3">
              <button type="button" class="btn btn-outline-secondary w-100" id="btn-limpiar-filtros">
                <i class="fas fa-eraser me-1"></i>Limpiar Filtros
              </button>
            </div>
          </form>
        </div>
        <!-- Columna derecha: Tabla de Pedidos (más ancha) -->
        <div class="col-md-9">
          <!-- Filtro en tiempo real de clientes -->
          <div class="row mb-2">
            <div class="col-12 col-md-6 mx-auto">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="filtro-cliente-tiempo-real" class="form-control" placeholder="Buscar cliente en tiempo real...">
                <button id="btn-limpiar-filtro-cliente" class="btn btn-outline-secondary" type="button" title="Limpiar búsqueda"><i class="fas fa-eraser"></i></button>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="tabla-pedidos-tiempo-real">
              <thead class="table-dark">
                <tr>
                  <th><i class="fas fa-user me-1"></i>Cliente</th>
                  <th><i class="fas fa-calendar me-1"></i>Fecha</th>
                  <th><i class="fas fa-coins me-1"></i>BRS</th>
                  <th><i class="fas fa-percentage me-1"></i>Tasa</th>
                  <th><i class="fas fa-calculator me-1"></i>CLP</th>
                  <th><i class="fas fa-university me-1"></i>Cuenta</th>
                  <th><i class="fas fa-money-bill-wave me-1"></i>Comisión</th>
                  <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for p in pedidos %}
                <tr>
                  <td class="td-cliente" data-cliente-original="{{ p.cliente }}">
                    <a href="#" class="text-decoration-none cliente-link" data-cliente="{{ p.cliente }}" title="Ver resumen de pedidos del día">
                      {{ p.cliente }}
                    </a>
                  </td>
                  <td>{{ p.fecha | format_date }}</td>
                  <td class="text-end">{{ p.brs | format_int }}</td>
                  <td class="text-end">{{ p.tasa | format_decimal5 | replace('.', ',') }}</td>
                  <td class="text-end fw-bold">{{ p.clp | format_int }}</td>
                  <td>
                    {% if p.cuentas_activas and p.cuentas_activas.numero_cuenta %}
                      ****{{ (p.cuentas_activas.numero_cuenta|string)[-4:] }}
                    {% else %}
                      <span class="text-muted">Sin cuenta</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{{ p.comision | default(0) | format_int }}</td>
                  <td class="align-middle">
                    <div class="btn-group" role="group">
                      <a href="{{ url_for('pedidos.editar', pedido_id=p.id) }}" class="btn btn-primary btn-sm" title="Editar">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-danger" title="Eliminar" 
                              onclick="confirmarEliminacion({{ p.id }}, '{{ p.cliente }}')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No se encontraron pedidos con los filtros aplicados</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="modalConfirmarEliminacion" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que quieres eliminar el pedido del cliente <strong id="cliente-eliminar"></strong>?</p>
        <p class="text-muted small">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="form-eliminar" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar tasas -->
<div class="modal fade" id="modalEditarTasas" tabindex="-1" aria-labelledby="modalEditarTasasLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('pedidos.editar_tasas') }}" id="formEditarTasas">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarTasasLabel"><i class="fas fa-edit me-2"></i>Editar Tasas de Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="tasa_banesco" class="form-label">Tasa Banesco</label>
            <input type="number" step="0.00001" min="0" max="999999" maxlength="7" class="form-control" id="tasa_banesco" name="tasa_banesco" value="{{ tasa_banesco }}" required>
            <div class="form-text">Máximo 6 cifras, incluyendo decimales.</div>
          </div>
          <div class="mb-3">
            <label for="tasa_venezuela" class="form-label">Tasa Venezuela</label>
            <input type="number" step="0.00001" min="0" max="999999" maxlength="7" class="form-control" id="tasa_venezuela" name="tasa_venezuela" value="{{ tasa_venezuela }}" required>
            <div class="form-text">Máximo 6 cifras, incluyendo decimales.</div>
          </div>
          <div class="mb-3">
            <label for="tasa_otros" class="form-label">Tasa Otros</label>
            <input type="number" step="0.00001" min="0" max="999999" maxlength="7" class="form-control" id="tasa_otros" name="tasa_otros" value="{{ tasa_otros }}" required>
            <div class="form-text">Máximo 6 cifras, incluyendo decimales.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Resumen de Pedidos del Día -->
<div class="modal fade" id="modalResumenPedidosDia" tabindex="-1" aria-labelledby="modalResumenPedidosDiaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalResumenPedidosDiaLabel">
          <i class="fas fa-calendar-day me-2"></i>Resumen de Pedidos del Día
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="loading-resumen" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando resumen...</p>
        </div>
        
        <div id="contenido-resumen" style="display: none;">
          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Cliente:</h6>
              <h5 id="cliente-resumen" class="text-primary"></h5>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Fecha:</h6>
              <h5 id="fecha-resumen" class="text-info"></h5>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total Pedidos</h6>
                  <h4 id="total-pedidos" class="text-primary">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total BRS</h6>
                  <h4 id="total-brs" class="text-success">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total CLP</h6>
                  <h4 id="total-clp" class="text-info">0</h4>
                </div>
              </div>
            </div>
          </div>
          
          <div id="tabla-pedidos-resumen" style="display: none;">
            <h6 class="text-muted mb-2">Detalle de Pedidos:</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>BRS</th>
                    <th>CLP</th>
                    <th>Tasa</th>
                  </tr>
                </thead>
                <tbody id="tbody-pedidos-resumen">
                </tbody>
              </table>
            </div>
          </div>
          
          <div id="sin-pedidos" class="text-center py-4" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No hay pedidos para hoy</h5>
            <p class="text-muted">Este cliente no tiene pedidos registrados para la fecha actual.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success" id="btn-copiar-whatsapp" style="display: none;">
          <i class="fab fa-whatsapp me-2"></i>Copiar para WhatsApp
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<style>
.cliente-link {
  color: #007bff !important;
  font-weight: 500 !important;
  transition: all 0.2s ease !important;
  text-decoration: none !important;
  cursor: pointer !important;
}

.cliente-link:hover {
  color: #0056b3 !important;
  text-decoration: underline !important;
  cursor: pointer !important;
}

.cliente-link:active {
  color: #004085 !important;
}

.td-cliente a {
  color: #007bff !important;
  font-weight: 500 !important;
  text-decoration: none !important;
  cursor: pointer !important;
}

.td-cliente a:hover {
  color: #0056b3 !important;
  text-decoration: underline !important;
}

#modalResumenPedidosDia .modal-dialog {
  max-width: 800px;
}

#tabla-pedidos-resumen .table {
  font-size: 0.9rem;
}

#tabla-pedidos-resumen th {
  font-size: 0.8rem;
  font-weight: 600;
}
</style>

{% block scripts %}
<script>
$(document).ready(function(){
  $('#cliente_pedidos').select2({
    width: '100%',
    placeholder: 'Seleccione un cliente',
    allowClear: true,
    minimumResultsForSearch: 0
  });
  
  $('#cuenta_pedidos').select2({
    width: '100%',
    placeholder: 'Seleccione una cuenta',
    allowClear: true,
    minimumResultsForSearch: 0
  });
  
  // Formateo automático para campos numéricos
  $('#brs_display').on('input', function() {
    let value = this.value.replace(/[^\d]/g, '');
    if (value) {
      this.value = parseInt(value, 10).toLocaleString('de-DE');
      $('#brs').val(value);
    } else {
      $('#brs').val('');
    }
  });
  
  // Inicializar campos numéricos al cargar la página
  if ($('#brs_display').val()) {
    let value = $('#brs_display').val().replace(/[^\d]/g, '');
    if (value) {
      $('#brs_display').val(parseInt(value, 10).toLocaleString('de-DE'));
      $('#brs').val(value);
    }
  }
  
  $('#clp_display').on('input', function() {
    let value = this.value.replace(/[^\d]/g, '');
    if (value) {
      this.value = parseInt(value, 10).toLocaleString('de-DE');
      $('#clp').val(value);
    } else {
      $('#clp').val('');
    }
  });
  
  // Inicializar campo CLP al cargar la página
  if ($('#clp_display').val()) {
    let value = $('#clp_display').val().replace(/[^\d]/g, '');
    if (value) {
      $('#clp_display').val(parseInt(value, 10).toLocaleString('de-DE'));
      $('#clp').val(value);
    }
  }
  
  // Limpiar filtros
  $('#btn-limpiar-filtros').on('click', function() {
    $('#cliente_pedidos').val('').trigger('change');
    $('#cuenta_pedidos').val('').trigger('change');
    $('#fecha').val('');
    $('#brs_display').val('');
    $('#brs').val('');
    $('#clp_display').val('');
    $('#clp').val('');
    $('#filtro-form').submit();
  });

  // Filtro en tiempo real de clientes en pedidos
  function aplicarFiltroClienteTiempoReal() {
    const filtro = $('#filtro-cliente-tiempo-real').val().toLowerCase();
    const filas = $('#tabla-pedidos-tiempo-real tbody tr');
    let visibles = 0;
    filas.each(function() {
      const fila = $(this);
      const tdCliente = fila.find('.td-cliente');
      const clienteOriginal = tdCliente.attr('data-cliente-original').toLowerCase();
      if (clienteOriginal.includes(filtro)) {
        fila.show();
        visibles++;
        // Resaltar coincidencia
        if (filtro) {
          const textoOriginal = tdCliente.attr('data-cliente-original');
          const textoResaltado = textoOriginal.replace(
            new RegExp(filtro, 'gi'),
            match => `<mark style="background-color: #ffeb3b; padding: 1px 2px; border-radius: 2px;">${match}</mark>`
          );
          tdCliente.html(textoResaltado);
        } else {
          tdCliente.html(tdCliente.attr('data-cliente-original'));
        }
      } else {
        fila.hide();
      }
    });
    // Si no hay filas visibles, mostrar mensaje
    let mensaje = $('#mensaje-no-coincidencias-pedidos');
    if (visibles === 0 && filtro) {
      if (mensaje.length === 0) {
        mensaje = $('<tr id="mensaje-no-coincidencias-pedidos"><td colspan="8" class="text-center text-danger"><i class="fas fa-search me-2"></i>No hay pedidos que coincidan con el cliente buscado.</td></tr>');
        $('#tabla-pedidos-tiempo-real tbody').append(mensaje);
      }
    } else {
      mensaje.remove();
    }
  }
  $('#filtro-cliente-tiempo-real').on('input', aplicarFiltroClienteTiempoReal);
  $('#btn-limpiar-filtro-cliente').on('click', function() {
    $('#filtro-cliente-tiempo-real').val('');
    aplicarFiltroClienteTiempoReal();
    $(this).addClass('btn-secondary').removeClass('btn-outline-secondary');
    setTimeout(() => {
      $(this).removeClass('btn-secondary').addClass('btn-outline-secondary');
    }, 200);
  });
  // Inicializar filtro al cargar
  aplicarFiltroClienteTiempoReal();
});

// Función para confirmar eliminación
function confirmarEliminacion(pedidoId, cliente) {
  document.getElementById('cliente-eliminar').textContent = cliente;
  document.getElementById('form-eliminar').action = `/pedidos/eliminar/${pedidoId}`;
  
  const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminacion'));
  modal.show();
}

// Función para mostrar resumen de pedidos del día
function mostrarResumenPedidosDia(cliente) {
  // Mostrar loading
  $('#loading-resumen').show();
  $('#contenido-resumen').hide();
  $('#btn-copiar-whatsapp').hide();
  
  // Hacer petición AJAX
  $.ajax({
    url: `/pedidos/api/cliente/${encodeURIComponent(cliente)}`,
    method: 'GET',
    success: function(response) {
      if (response.success) {
        // Ocultar loading y mostrar contenido
        $('#loading-resumen').hide();
        $('#contenido-resumen').show();
        
        // Llenar datos del cliente
        $('#cliente-resumen').text(response.cliente);
        $('#fecha-resumen').text(response.fecha);
        $('#total-pedidos').text(response.cantidad_pedidos);
        $('#total-brs').text(response.total_brs);
        $('#total-clp').text(response.total_clp);
        
        if (response.cantidad_pedidos > 0) {
          // Mostrar tabla de pedidos
          $('#tabla-pedidos-resumen').show();
          $('#sin-pedidos').hide();
          $('#btn-copiar-whatsapp').show();
          
          // Llenar tabla
          const tbody = $('#tbody-pedidos-resumen');
          tbody.empty();
          
          response.pedidos.forEach(function(pedido) {
            const row = `
              <tr>
                <td><strong>${pedido.numero}</strong></td>
                <td class="text-end">${pedido.brs}</td>
                <td class="text-end fw-bold">${pedido.clp}</td>
                <td class="text-end">${pedido.tasa}</td>
              </tr>
            `;
            tbody.append(row);
          });
        } else {
          // Mostrar mensaje de sin pedidos
          $('#tabla-pedidos-resumen').hide();
          $('#sin-pedidos').show();
        }
      } else {
        // Mostrar error
        $('#loading-resumen').hide();
        $('#contenido-resumen').show();
        $('#tabla-pedidos-resumen').hide();
        $('#sin-pedidos').show();
        $('#sin-pedidos h5').text('Error al cargar datos');
        $('#sin-pedidos p').text(response.error || 'Ocurrió un error al obtener los datos.');
      }
    },
    error: function(xhr, status, error) {
      // Mostrar error
      $('#loading-resumen').hide();
      $('#contenido-resumen').show();
      $('#tabla-pedidos-resumen').hide();
      $('#sin-pedidos').show();
      $('#sin-pedidos h5').text('Error de conexión');
      $('#sin-pedidos p').text('No se pudo conectar con el servidor.');
    }
  });
}

// Función para copiar mensaje de WhatsApp
function copiarMensajeWhatsApp() {
  const cliente = $('#cliente-resumen').text();
  const fecha = $('#fecha-resumen').text();
  const totalBrs = $('#total-brs').text();
  const totalClp = $('#total-clp').text();
  const cantidadPedidos = $('#total-pedidos').text();
  
  let mensaje = `📋 *RESUMEN DE PEDIDOS DEL DÍA*\n\n`;
  mensaje += `👤 *Cliente:* ${cliente}\n`;
  mensaje += `📅 *Fecha:* ${fecha}\n`;
  mensaje += `📊 *Total Pedidos:* ${cantidadPedidos}\n\n`;
  
  // Agregar detalles de pedidos si existen
  const filas = $('#tbody-pedidos-resumen tr');
  if (filas.length > 0) {
    mensaje += `📝 *DETALLE DE PEDIDOS:*\n\n`;
    filas.each(function() {
      const numero = $(this).find('td:first').text().trim();
      const brs = $(this).find('td:nth-child(2)').text().trim();
      const clp = $(this).find('td:nth-child(3)').text().trim();
      mensaje += `Pedido ${numero}:\n`;
      mensaje += `BRS: ${brs} | CLP: ${clp}\n\n`;
    });
  }
  
  mensaje += `💰 *TOTALES:*\n`;
  mensaje += `BRS: ${totalBrs} | CLP: ${totalClp}\n\n`;
  mensaje += `✅ *Resumen generado automáticamente*`;
  
  // Copiar al portapapeles
  navigator.clipboard.writeText(mensaje).then(function() {
    // Mostrar notificación de éxito
    const btn = $('#btn-copiar-whatsapp');
    const originalText = btn.html();
    btn.html('<i class="fas fa-check me-2"></i>¡Copiado!');
    btn.removeClass('btn-success').addClass('btn-success');
    
    setTimeout(function() {
      btn.html(originalText);
    }, 2000);
  }).catch(function(err) {
    console.error('Error al copiar: ', err);
    alert('Error al copiar al portapapeles. Por favor, copia manualmente el mensaje.');
  });
}

// Event listeners
$(document).ready(function() {
  console.log('Document ready - Pedidos page');
  
  // Click en enlaces de cliente
  $(document).on('click', '.cliente-link', function(e) {
    e.preventDefault();
    console.log('Cliente link clicked:', $(this).data('cliente'));
    const cliente = $(this).data('cliente');
    mostrarResumenPedidosDia(cliente);
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalResumenPedidosDia'));
    modal.show();
  });
  
  // Click en botón de copiar WhatsApp
  $('#btn-copiar-whatsapp').on('click', copiarMensajeWhatsApp);
  
  // Verificar que los enlaces existen
  console.log('Enlaces de cliente encontrados:', $('.cliente-link').length);
});
</script>
{% endblock %}