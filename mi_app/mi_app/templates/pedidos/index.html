{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-2">
  <!-- Cabecera con título y botones alineados a la izquierda -->
  <div class="d-flex align-items-center gap-2 flex-wrap mb-3">
    <h1 class="mb-0 me-2">
      <i class="fas fa-shopping-cart me-2"></i>Pedidos
    </h1>
    {% if pedidos %}
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#resumenPedidos" aria-expanded="false" aria-controls="resumenPedidos">
      <i class="fas fa-chart-bar me-1"></i>Mostrar resumen
    </button>
    {% endif %}
    <a href="{{ url_for('pedidos.nuevo') }}" class="btn btn-success">
      <i class="fas fa-plus me-1"></i>Nuevo Pedido
    </a>
    <a href="{{ url_for('pedidos.flujo_caja') }}" class="btn btn-info">
      <i class="fas fa-chart-line me-1"></i>Flujo de Caja
    </a>
    {% if is_superuser %}
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalEditarTasas">
      <i class="fas fa-edit me-1"></i>Editar Tasas
    </button>
    {% endif %}
  </div>

  <!-- Resumen de resultados (arriba, oculto tras botón) -->
  {% if pedidos %}
  <div class="mb-3">
    <div class="collapse" id="resumenPedidos">
      <div class="p-3 bg-light rounded">
        <div class="row text-center">
          <div class="col-md-2">
            <h6 class="text-muted">Total Pedidos</h6>
            <h4 class="text-primary">{{ pedidos|length }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Total BRS</h6>
            <h4 class="text-success">{{ pedidos|sum(attribute='brs')|format_int }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Total CLP</h6>
            <h4 class="text-info">{{ pedidos|sum(attribute='clp')|format_int }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Tasa Ponderada</h6>
            <h4 class="text-warning">{{ tasa_ponderada|format_decimal5 }}</h4>
          </div>
          <div class="col-md-2">
            <h6 class="text-muted">Total Comisión</h6>
            <h4 class="text-danger">{{ total_comisiones|format_int }}</h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Barra horizontal de tasas estilo ticker -->
  <div class="rate-ticker border rounded px-3 py-2 mb-3">
    <div class="ticker-content d-inline-flex align-items-center gap-3">
      <span class="rate-item"><strong>Banesco</strong> <span class="text-success">{{ tasa_banesco }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Venezuela</strong> <span class="text-primary">{{ tasa_venezuela }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Otros</strong> <span class="text-warning">{{ tasa_otros }}</span></span>
      <!-- Duplicamos el contenido para un scroll continuo -->
      <span class="divider">|</span>
      <span class="rate-item"><strong>Banesco</strong> <span class="text-success">{{ tasa_banesco }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Venezuela</strong> <span class="text-primary">{{ tasa_venezuela }}</span></span>
      <span class="divider">|</span>
      <span class="rate-item"><strong>Otros</strong> <span class="text-warning">{{ tasa_otros }}</span></span>
    </div>
  </div>
  <!-- Estilos del ticker se encuentran en static/css/styles.css -->

  <!-- Filtros en tiempo real -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-light">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="fas fa-filter me-1"></i>Filtros en tiempo real
        </h6>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary" id="contador-resultados">
            {{ pedidos|length }} pedidos
          </span>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-limpiar-filtros">
            <i class="fas fa-eraser me-1"></i>Limpiar
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2">
          <label for="filtro-cliente" class="form-label small text-muted">
            <i class="fas fa-user me-1"></i>Cliente
          </label>
          <input type="text" class="form-control form-control-sm" id="filtro-cliente" placeholder="Buscar cliente...">
        </div>
        <div class="col-md-2">
          <label for="filtro-brs" class="form-label small text-muted">
            <i class="fas fa-coins me-1"></i>BRS
          </label>
          <input type="text" class="form-control form-control-sm" id="filtro-brs" placeholder="Buscar BRS...">
        </div>
        <div class="col-md-2">
          <label for="filtro-clp" class="form-label small text-muted">
            <i class="fas fa-calculator me-1"></i>CLP
          </label>
          <input type="text" class="form-control form-control-sm" id="filtro-clp" placeholder="Buscar CLP...">
        </div>
        <div class="col-md-2">
          <label for="filtro-fecha" class="form-label small text-muted">
            <i class="fas fa-calendar me-1"></i>Fecha
          </label>
          <input type="text" class="form-control form-control-sm" id="filtro-fecha" placeholder="Buscar fecha...">
        </div>
        <div class="col-md-2">
          <label for="filtro-cuenta" class="form-label small text-muted">
            <i class="fas fa-university me-1"></i>Cuenta Corriente
          </label>
          <input type="text" class="form-control form-control-sm" id="filtro-cuenta" placeholder="Buscar cuenta...">
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de Pedidos -->
  <div class="card shadow-lg">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tabla-pedidos">
          <thead class="table-dark">
            <tr>
              <th><i class="fas fa-user me-1"></i>Cliente</th>
              <th><i class="fas fa-calendar me-1"></i>Fecha</th>
              <th><i class="fas fa-coins me-1"></i>BRS</th>
              <th><i class="fas fa-percentage me-1"></i>Tasa</th>
              <th><i class="fas fa-calculator me-1"></i>CLP</th>
              <th><i class="fas fa-university me-1"></i>Cuenta</th>
              <th><i class="fas fa-money-bill-wave me-1"></i>Comisión</th>
              <th><i class="fas fa-cogs me-1"></i>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pedidos %}
            <tr class="fila-pedido" 
                data-cliente="{{ p.cliente|lower }}" 
                data-brs="{{ p.brs }}" 
                data-clp="{{ p.clp }}" 
                data-fecha="{{ p.fecha | format_date|lower }}" 
                data-cuenta="{% if p.cuentas_activas and p.cuentas_activas.numero_cuenta %}****{{ (p.cuentas_activas.numero_cuenta|string)[-4:] }}{% else %}sin cuenta{% endif %}">
              <td><strong>{{ p.cliente }}</strong></td>
              <td>{{ p.fecha | format_date }}</td>
              <td class="text-end">{{ p.brs | format_int }}</td>
              <td class="text-end">{{ p.tasa | format_decimal5 | replace('.', ',') }}</td>
              <td class="text-end fw-bold">{{ p.clp | format_int }}</td>
              <td>
                {% if p.cuentas_activas and p.cuentas_activas.numero_cuenta %}
                  ****{{ (p.cuentas_activas.numero_cuenta|string)[-4:] }}
                {% else %}
                  <span class="text-muted">Sin cuenta</span>
                {% endif %}
              </td>
              <td class="text-center">{{ p.comision | default(0) | format_int }}</td>
              <td>
                <div class="btn-group" role="group">
                  <a href="{{ url_for('pedidos.editar', pedido_id=p.id) }}" class="btn btn-sm btn-primary" title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button type="button" class="btn btn-sm btn-danger" title="Eliminar" 
                          onclick="confirmarEliminacion({{ p.id }}, '{{ p.cliente }}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p class="mb-0">No se encontraron pedidos</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="modalConfirmarEliminacion" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que quieres eliminar el pedido del cliente <strong id="cliente-eliminar"></strong>?</p>
        <p class="text-muted small">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="form-eliminar" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Script para filtros en tiempo real -->
<script>
$(document).ready(function(){
  // Función para aplicar filtros
  function aplicarFiltros() {
    const filtroCliente = $('#filtro-cliente').val().toLowerCase();
    const filtroBrs = $('#filtro-brs').val().toLowerCase();
    const filtroClp = $('#filtro-clp').val().toLowerCase();
    const filtroFecha = $('#filtro-fecha').val().toLowerCase();
    const filtroCuenta = $('#filtro-cuenta').val().toLowerCase();
    
    let filasVisibles = 0;
    
    $('.fila-pedido').each(function() {
      const $fila = $(this);
      const cliente = $fila.data('cliente');
      const brs = $fila.data('brs').toString();
      const clp = $fila.data('clp').toString();
      const fecha = $fila.data('fecha');
      const cuenta = $fila.data('cuenta');
      
      const coincideCliente = !filtroCliente || cliente.includes(filtroCliente);
      const coincideBrs = !filtroBrs || brs.includes(filtroBrs);
      const coincideClp = !filtroClp || clp.includes(filtroClp);
      const coincideFecha = !filtroFecha || fecha.includes(filtroFecha);
      const coincideCuenta = !filtroCuenta || cuenta.includes(filtroCuenta);
      
      if (coincideCliente && coincideBrs && coincideClp && coincideFecha && coincideCuenta) {
        $fila.show();
        filasVisibles++;
        
        // Resaltar coincidencias
        $fila.find('td').each(function() {
          const $celda = $(this);
          const texto = $celda.text().toLowerCase();
          
          if (filtroCliente && texto.includes(filtroCliente)) {
            $celda.addClass('highlight-match');
          } else if (filtroBrs && texto.includes(filtroBrs)) {
            $celda.addClass('highlight-match');
          } else if (filtroClp && texto.includes(filtroClp)) {
            $celda.addClass('highlight-match');
          } else if (filtroFecha && texto.includes(filtroFecha)) {
            $celda.addClass('highlight-match');
          } else if (filtroCuenta && texto.includes(filtroCuenta)) {
            $celda.addClass('highlight-match');
          } else {
            $celda.removeClass('highlight-match');
          }
        });
      } else {
        $fila.hide();
        $fila.find('td').removeClass('highlight-match');
      }
    });
    
    // Actualizar contador
    $('#contador-resultados').text(filasVisibles + ' pedidos');
    
    // Mostrar mensaje si no hay resultados
    if (filasVisibles === 0) {
      if ($('#tabla-pedidos tbody tr.no-results').length === 0) {
        $('#tabla-pedidos tbody').append(`
          <tr class="no-results">
            <td colspan="8" class="text-center text-muted py-4">
              <i class="fas fa-search fa-2x mb-2"></i>
              <p class="mb-0">No se encontraron pedidos con los filtros aplicados</p>
            </td>
          </tr>
        `);
      }
    } else {
      $('.no-results').remove();
    }
  }
  
  // Event listeners para filtros
  $('#filtro-cliente, #filtro-brs, #filtro-clp, #filtro-fecha, #filtro-cuenta').on('input', function() {
    aplicarFiltros();
  });
  
  // Botón limpiar filtros
  $('#btn-limpiar-filtros').on('click', function() {
    $('#filtro-cliente, #filtro-brs, #filtro-clp, #filtro-fecha, #filtro-cuenta').val('');
    $('.fila-pedido').show();
    $('.fila-pedido td').removeClass('highlight-match');
    $('.no-results').remove();
    $('#contador-resultados').text('{{ pedidos|length }} pedidos');
  });
  
  // Aplicar sombreado alterno
  $('#tabla-pedidos tbody tr:visible:even').addClass('table-light');
});

// Función para confirmar eliminación
function confirmarEliminacion(pedidoId, cliente) {
  document.getElementById('cliente-eliminar').textContent = cliente;
  document.getElementById('form-eliminar').action = `/pedidos/eliminar/${pedidoId}`;
  
  const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminacion'));
  modal.show();
}
</script>

<!-- Modal para editar tasas -->
<div class="modal fade" id="modalEditarTasas" tabindex="-1" aria-labelledby="modalEditarTasasLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('pedidos.editar_tasas') }}" id="formEditarTasas">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarTasasLabel"><i class="fas fa-edit me-2"></i>Editar Tasas de Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="tasa_banesco" class="form-label">Tasa Banesco</label>
            <input type="number" step="0.00001" min="0" max="999999" maxlength="7" class="form-control" id="tasa_banesco" name="tasa_banesco" value="{{ tasa_banesco }}" required>
            <div class="form-text">Máximo 6 cifras, incluyendo decimales.</div>
          </div>
          <div class="mb-3">
            <label for="tasa_venezuela" class="form-label">Tasa Venezuela</label>
            <input type="number" step="0.00001" min="0" max="999999" maxlength="7" class="form-control" id="tasa_venezuela" name="tasa_venezuela" value="{{ tasa_venezuela }}" required>
            <div class="form-text">Máximo 6 cifras, incluyendo decimales.</div>
          </div>
          <div class="mb-3">
            <label for="tasa_otros" class="form-label">Tasa Otros</label>
            <input type="number" step="0.00001" min="0" max="999999" maxlength="7" class="form-control" id="tasa_otros" name="tasa_otros" value="{{ tasa_otros }}" required>
            <div class="form-text">Máximo 6 cifras, incluyendo decimales.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Validación de máximo 6 cifras (enteros+decimales) en el modal
function validarCifras(input) {
  let valor = input.value.replace(/,/g, '.');
  if (valor.includes('.')) {
    valor = valor.replace(/\.+/g, '.');
    let partes = valor.split('.');
    if ((partes[0] + partes[1]).length > 6) {
      input.value = valor.slice(0, 6);
    }
  } else {
    if (valor.length > 6) {
      input.value = valor.slice(0, 6);
    }
  }
}
document.addEventListener('DOMContentLoaded', function() {
  ['tasa_banesco', 'tasa_venezuela', 'tasa_otros'].forEach(function(id) {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', function() { validarCifras(input); });
    }
  });

  // Envío AJAX del formulario de tasas
  const formTasas = document.getElementById('formEditarTasas');
  if (formTasas) {
    formTasas.addEventListener('submit', function(e) {
      e.preventDefault();
      const tasa_banesco = document.getElementById('tasa_banesco').value;
      const tasa_venezuela = document.getElementById('tasa_venezuela').value;
      const tasa_otros = document.getElementById('tasa_otros').value;
      fetch('/pedidos/editar_tasas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          tasa_banesco: tasa_banesco,
          tasa_venezuela: tasa_venezuela,
          tasa_otros: tasa_otros
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          toastr.success('Tasas actualizadas correctamente');
          setTimeout(() => location.reload(), 1200);
        } else {
          toastr.error('Error: ' + (data.error || data.message));
        }
      })
      .catch(error => {
        toastr.error('Error en la petición: ' + error);
      });
    });
  }
});
</script>
{% endblock %}