{% extends "base.html" %}
{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
{% endblock %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
  </ol>
</nav>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>Resumen de pedidos por cliente</h1>
  <div class="d-flex justify-content-end align-items-center mb-2" style="gap:1rem;">
    <label class="mb-0">Actualizar cada 
      <select id="refresh-interval" class="form-select form-select-sm d-inline-block w-auto" style="width:auto;">
        <option value="3">3 seg</option>
        <option value="5">5 seg</option>
        <option value="30">30 seg</option>
        <option value="60" selected>60 seg</option>
      </select>
    </label>
    <button id="refresh-manual" class="btn btn-outline-primary btn-sm" title="Actualizar ahora"><i class="fas fa-sync-alt"></i></button>
    <button id="toggle-auto" class="btn btn-outline-secondary btn-sm" title="Desactivar actualización automática"><i class="fas fa-pause"></i></button>
  </div>
  <div class="row mb-3 gy-2 gx-2 flex-column flex-md-row">
    <div class="col-12 col-md-6 mb-2 mb-md-0">
      <div class="input-group">
        <input type="text" id="filtro-cliente" class="form-control" placeholder="Buscar cliente...">
        <button class="btn btn-outline-secondary" id="btn-limpiar-filtros" type="button" title="Limpiar filtros"><i class="fas fa-eraser"></i></button>
      </div>
    </div>
    <div class="col-12 col-md-4 mb-2 mb-md-0">
      <select id="filtro-estado" class="form-select">
        <option value="">Todos los estados</option>
        <option value="deuda">Con deuda</option>
        <option value="favor">Saldo a favor</option>
        <option value="cero">Sin saldo</option>
      </select>
    </div>
    <div class="col-12 col-md-2 d-flex align-items-center justify-content-md-end mt-2 mt-md-0">
      <button class="btn btn-success w-100" id="btn-exportar" type="button"><i class="fas fa-file-excel me-1"></i>Exportar</button>
    </div>
  </div>
  <div class="card shadow-lg">
    <div class="card-body">
      <div id="loading-indicator" class="text-center py-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Actualizando datos...</p>
      </div>
      <table class="table table-striped align-middle" id="tabla-dashboard" style="min-width:900px;">
        <thead style="position: sticky; top: 0; z-index: 2; background: #083366; color: white;">
          <tr>
            <th class="sortable" data-col="0">Cliente <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="1">Deuda anterior <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="2">BRS <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="3">Deuda de hoy <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="4">Pagos <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="5">Saldo Final <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="6">Estado <span class="sort-arrow"></span></th>
            <th>Copiar</th>
          </tr>
        </thead>
        <tbody>
          {% for r in resumen %}
          <tr data-cliente="{{ r.cliente|lower }}" data-estado="{% if r.diferencia > 0 %}deuda{% elif r.diferencia < 0 %}favor{% else %}cero{% endif %}">
            <td class="td-cliente">{{ r.cliente }}</td>
            <td>{{ r.deuda_anterior | format_int }}</td>
            <td>{{ r.brs | format_int }}</td>
            <td>{{ r.clp | format_int }}</td>
            <td class="td-pagos">{{ r.pagos | format_int }}</td>
            <td class="td-saldo-final">
              {% if r.diferencia > 0 %}
                <span class="text-danger fw-bold px-2 py-1 rounded border border-danger shadow-sm" style="background:#ffe5e5;" title="¡Este cliente tiene deuda pendiente!">
                  <i class="fas fa-exclamation-triangle me-1"></i>{{ r.diferencia | format_int }}
                </span>
              {% else %}
                {{ r.diferencia | format_int }}
              {% endif %}
            </td>
            <td>
              {% if r.diferencia > 0 %}
                <span id="estado-msg-{{ loop.index }}">Saldo pendiente {{ r.diferencia | format_int }} Clp</span>
              {% elif r.diferencia < 0 %}
                <span id="estado-msg-{{ loop.index }}">Saldo a Favor de {{ (r.diferencia * -1) | format_int }} Clp</span>
              {% else %}
                <span id="estado-msg-{{ loop.index }}">Sin saldo pendiente</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-outline-secondary btn-sm" onclick="copiarEstado('estado-msg-{{ loop.index }}')" title="Copiar mensaje"><i class="fas fa-copy"></i></button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center">No hay pedidos para la fecha seleccionada.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-info fw-bold">
            <td colspan="4" class="text-end">Totales:</td>
            <td id="total-pagos"></td>
            <td id="total-saldo-final"></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  <style>
    @media (max-width: 768px) {
      #tabla-dashboard { font-size: 0.95rem; }
      .input-group, .form-select { width: 100%; }
      .card-body { padding: 0.5rem; }
    }
    @media (max-width: 576px) {
      #tabla-dashboard { min-width: 700px; }
    }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable .sort-arrow { font-size: 0.9em; margin-left: 2px; }
  </style>
  <script>
  // Variables globales
  let dashboardData = [];
  let currentFecha = '{{ fecha }}';
  let currentCliente = '{{ cliente_filtro }}';
  let autoRefresh = true;
  let refreshTimer = null;
  let isLoading = false;

  // Función para formatear números
  function formatNumber(num) {
    return new Intl.NumberFormat('es-CL', {maximumFractionDigits: 0}).format(num);
  }

  // Función para copiar estado
  function copiarEstado(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const texto = el.innerText;
    navigator.clipboard.writeText(texto).then(function() {
      el.classList.add('bg-success','text-white');
      setTimeout(() => el.classList.remove('bg-success','text-white'), 800);
    });
  }

  // Función para cargar datos del dashboard
  async function cargarDashboard() {
    if (isLoading) return;
    isLoading = true;
    
    // Mostrar indicador de carga
    const loadingIndicator = document.getElementById('loading-indicator');
    const table = document.getElementById('tabla-dashboard');
    if (loadingIndicator && table) {
      loadingIndicator.style.display = 'block';
      table.style.opacity = '0.5';
    }
    
    try {
      const url = `/dashboard/api/datos?fecha=${currentFecha}&cliente=${currentCliente}`;
      const response = await fetch(url);
      const result = await response.json();
      
      if (result.success) {
        dashboardData = result.data;
        actualizarTabla();
        actualizarTimestamp(result.timestamp);
      } else {
        console.error('Error al cargar datos:', result.error);
        mostrarError('Error al cargar datos del dashboard');
      }
    } catch (error) {
      console.error('Error en la petición:', error);
      mostrarError('Error de conexión');
    } finally {
      isLoading = false;
      
      // Ocultar indicador de carga
      const loadingIndicator = document.getElementById('loading-indicator');
      const table = document.getElementById('tabla-dashboard');
      if (loadingIndicator && table) {
        loadingIndicator.style.display = 'none';
        table.style.opacity = '1';
      }
    }
  }

  // Función para actualizar la tabla
  function actualizarTabla() {
    const tbody = document.getElementById('tabla-dashboard').getElementsByTagName('tbody')[0];
    const tfoot = document.getElementById('tabla-dashboard').getElementsByTagName('tfoot')[0];
    
    if (dashboardData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay movimientos para la fecha seleccionada.</td></tr>';
      tfoot.style.display = 'none';
      return;
    }
    
    tfoot.style.display = '';
    let totalPagos = 0;
    let totalSaldoFinal = 0;
    
    const rows = dashboardData.map((r, index) => {
      const estado = r.diferencia > 0 ? 'deuda' : r.diferencia < 0 ? 'favor' : 'cero';
      const saldoClass = r.diferencia > 0 ? 'text-danger fw-bold px-2 py-1 rounded border border-danger shadow-sm' : '';
      const saldoStyle = r.diferencia > 0 ? 'background:#ffe5e5;' : '';
      const saldoIcon = r.diferencia > 0 ? '<i class="fas fa-exclamation-triangle me-1"></i>' : '';
      
      totalPagos += r.pagos;
      totalSaldoFinal += r.diferencia;
      
      return `
        <tr data-cliente="${r.cliente.toLowerCase()}" data-estado="${estado}">
          <td class="td-cliente">${r.cliente}</td>
          <td>${formatNumber(r.deuda_anterior)}</td>
          <td>${formatNumber(r.brs)}</td>
          <td>${formatNumber(r.clp)}</td>
          <td class="td-pagos">${formatNumber(r.pagos)}</td>
          <td class="td-saldo-final">
            ${r.diferencia > 0 ? 
              `<span class="${saldoClass}" style="${saldoStyle}" title="¡Este cliente tiene deuda pendiente!">${saldoIcon}${formatNumber(r.diferencia)}</span>` : 
              formatNumber(r.diferencia)
            }
          </td>
          <td>
            <span id="estado-msg-${index + 1}">
              ${r.diferencia > 0 ? 
                `Saldo pendiente ${formatNumber(r.diferencia)} Clp` : 
                r.diferencia < 0 ? 
                `Saldo a Favor de ${formatNumber(Math.abs(r.diferencia))} Clp` : 
                'Sin saldo pendiente'
              }
            </span>
          </td>
          <td>
            <button class="btn btn-outline-secondary btn-sm" onclick="copiarEstado('estado-msg-${index + 1}')" title="Copiar mensaje">
              <i class="fas fa-copy"></i>
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows;
    
    // Actualizar totales
    document.getElementById('total-pagos').textContent = formatNumber(totalPagos);
    document.getElementById('total-saldo-final').textContent = formatNumber(totalSaldoFinal);
    
    // Aplicar filtros si existen
    aplicarFiltros();
  }

  // Función para aplicar filtros
  function aplicarFiltros() {
    const inputCliente = document.getElementById('filtro-cliente');
    const selectEstado = document.getElementById('filtro-estado');
    const texto = inputCliente.value.toLowerCase();
    const estado = selectEstado.value;
    
    const filas = document.querySelectorAll('#tabla-dashboard tbody tr');
    let visibles = 0;
    
    filas.forEach(fila => {
      const cliente = fila.getAttribute('data-cliente') || '';
      const estadoFila = fila.getAttribute('data-estado') || '';
      const coincideCliente = cliente.includes(texto);
      const coincideEstado = !estado || estadoFila === estado;
      const mostrar = coincideCliente && coincideEstado;
      
      fila.style.display = mostrar ? '' : 'none';
      
      if (mostrar) {
        visibles++;
        // Resaltar búsqueda
        const tdCliente = fila.querySelector('.td-cliente');
        if (tdCliente && texto) {
          const original = tdCliente.textContent;
          const regex = new RegExp(`(${texto.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
          tdCliente.innerHTML = original.replace(regex, '<mark>$1</mark>');
        }
      }
    });
    
    // Mostrar mensaje si no hay coincidencias
    let mensaje = document.getElementById('mensaje-no-coincidencias');
    if (visibles === 0 && (texto || estado)) {
      if (!mensaje) {
        mensaje = document.createElement('tr');
        mensaje.id = 'mensaje-no-coincidencias';
        mensaje.innerHTML = '<td colspan="8" class="text-center text-danger">No hay coincidencias para el filtro actual.</td>';
        document.querySelector('#tabla-dashboard tbody').appendChild(mensaje);
      }
    } else {
      if (mensaje) mensaje.remove();
    }
  }

  // Función para mostrar error
  function mostrarError(mensaje) {
    const tbody = document.getElementById('tabla-dashboard').getElementsByTagName('tbody')[0];
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">${mensaje}</td></tr>`;
  }

  // Función para actualizar timestamp
  function actualizarTimestamp(timestamp) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-CL');
    document.title = `Dashboard - Actualizado: ${timeStr}`;
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    const inputCliente = document.getElementById('filtro-cliente');
    const selectEstado = document.getElementById('filtro-estado');
    const btnLimpiar = document.getElementById('btn-limpiar-filtros');
    const btnExportar = document.getElementById('btn-exportar');
    const refreshInterval = document.getElementById('refresh-interval');
    const refreshManual = document.getElementById('refresh-manual');
    const toggleAuto = document.getElementById('toggle-auto');

    // Filtros
    inputCliente.addEventListener('input', aplicarFiltros);
    selectEstado.addEventListener('change', aplicarFiltros);
    
    btnLimpiar.addEventListener('click', function() {
      inputCliente.value = '';
      selectEstado.value = '';
      aplicarFiltros();
    });

    // Exportar
    btnExportar.addEventListener('click', function() {
      const data = dashboardData.map(r => ({
        Cliente: r.cliente,
        'Deuda Anterior': r.deuda_anterior,
        'BRS': r.brs,
        'CLP': r.clp,
        'Pagos': r.pagos,
        'Saldo Final': r.diferencia
      }));
      
      const csv = Papa.unparse(data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dashboard_${currentFecha}.csv`;
      link.click();
    });

    // Actualización automática
    refreshManual.addEventListener('click', async function() {
      // Limpiar caché antes de recargar
      try {
        await fetch('/dashboard/limpiar_cache', { method: 'POST' });
      } catch (e) { /* ignorar error */ }
      cargarDashboard();
    });
    
    toggleAuto.addEventListener('click', function() {
      autoRefresh = !autoRefresh;
      localStorage.setItem('dashboard_auto_refresh', autoRefresh);
      
      if (autoRefresh) {
        this.innerHTML = '<i class="fas fa-pause"></i>';
        this.title = 'Desactivar actualización automática';
        iniciarAutoRefresh();
      } else {
        this.innerHTML = '<i class="fas fa-play"></i>';
        this.title = 'Activar actualización automática';
        if (refreshTimer) clearInterval(refreshTimer);
      }
    });

    refreshInterval.addEventListener('change', function() {
      if (autoRefresh) {
        if (refreshTimer) clearInterval(refreshTimer);
        iniciarAutoRefresh();
      }
    });

    function iniciarAutoRefresh() {
      const interval = parseInt(refreshInterval.value) * 1000;
      refreshTimer = setInterval(cargarDashboard, interval);
    }

         // Cargar datos iniciales
     cargarDashboard();
     
     // Iniciar auto-refresh si está habilitado
     if (autoRefresh) {
       iniciarAutoRefresh();
     }
   });
  </script>
</div>
{% endblock %}
