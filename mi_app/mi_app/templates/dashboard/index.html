{% extends "base.html" %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
  </ol>
</nav>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>Resumen de pedidos por cliente</h1>
  <div class="d-flex justify-content-end align-items-center mb-2" style="gap:1rem;">
    <label class="mb-0">Actualizar cada 
      <select id="refresh-interval" class="form-select form-select-sm d-inline-block w-auto" style="width:auto;">
        <option value="3">3 seg</option>
        <option value="5">5 seg</option>
        <option value="30">30 seg</option>
        <option value="60" selected>60 seg</option>
      </select>
    </label>
    <button id="refresh-manual" class="btn btn-outline-primary btn-sm" title="Actualizar ahora"><i class="fas fa-sync-alt"></i></button>
    <button id="toggle-auto" class="btn btn-outline-secondary btn-sm" title="Desactivar actualización automática"><i class="fas fa-pause"></i></button>
  </div>
  <div class="row mb-3">
    <div class="col-md-6 mb-2">
      <input type="text" id="filtro-cliente" class="form-control" placeholder="Buscar cliente...">
    </div>
    <div class="col-md-4 mb-2">
      <select id="filtro-estado" class="form-select">
        <option value="">Todos los estados</option>
        <option value="deuda">Con deuda</option>
        <option value="favor">Saldo a favor</option>
        <option value="cero">Sin saldo</option>
      </select>
    </div>
  </div>
  <div class="card shadow-lg">
    <div class="card-body">
      <table class="table table-striped" id="tabla-dashboard">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Deuda anterior</th>
            <th>BRS</th>
            <th>Deuda de hoy</th>
            <th>Pagos</th>
            <th>Saldo Final</th>
            <th>Estado</th>
            <th>Copiar</th>
          </tr>
        </thead>
        <tbody>
          {% for r in resumen %}
          <tr data-cliente="{{ r.cliente|lower }}" data-estado="{% if r.diferencia > 0 %}deuda{% elif r.diferencia < 0 %}favor{% else %}cero{% endif %}">
            <td>{{ r.cliente }}</td>
            <td>{{ r.deuda_anterior | format_int }}</td>
            <td>{{ r.brs | format_int }}</td>
            <td>{{ r.clp | format_int }}</td>
            <td>{{ r.pagos | format_int }}</td>
            <td>
              {% if r.diferencia > 0 %}
                <span class="text-danger fw-bold px-2 py-1 rounded border border-danger shadow-sm" style="background:#ffe5e5;" title="¡Este cliente tiene deuda pendiente!">
                  <i class="fas fa-exclamation-triangle me-1"></i>{{ r.diferencia | format_int }}
                </span>
              {% else %}
                {{ r.diferencia | format_int }}
              {% endif %}
            </td>
            <td>
              {% if r.diferencia > 0 %}
                <span id="estado-msg-{{ loop.index }}">Saldo pendiente {{ r.diferencia | format_int }} Clp</span>
              {% elif r.diferencia < 0 %}
                <span id="estado-msg-{{ loop.index }}">Saldo a Favor de {{ (r.diferencia * -1) | format_int }} Clp</span>
              {% else %}
                <span id="estado-msg-{{ loop.index }}">Sin saldo pendiente</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-outline-secondary btn-sm" onclick="copiarEstado('estado-msg-{{ loop.index }}')" title="Copiar mensaje"><i class="fas fa-copy"></i></button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center">No hay pedidos para la fecha seleccionada.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <script>
  function copiarEstado(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const texto = el.innerText;
    navigator.clipboard.writeText(texto).then(function() {
      el.classList.add('bg-success','text-white');
      setTimeout(() => el.classList.remove('bg-success','text-white'), 800);
    });
  }
  // Filtro en vivo por cliente y estado
  const inputCliente = document.getElementById('filtro-cliente');
  const selectEstado = document.getElementById('filtro-estado');
  const tabla = document.getElementById('tabla-dashboard').getElementsByTagName('tbody')[0];
  const filas = Array.from(tabla.rows);
  const mensajeNoCoincidenciasId = 'mensaje-no-coincidencias';
  function filtrarTabla() {
    const texto = inputCliente.value.toLowerCase();
    const estado = selectEstado.value;
    let visibles = 0;
    filas.forEach(fila => {
      const cliente = fila.getAttribute('data-cliente') || '';
      const estadoFila = fila.getAttribute('data-estado') || '';
      const coincideCliente = cliente.includes(texto);
      const coincideEstado = !estado || estadoFila === estado;
      const mostrar = coincideCliente && coincideEstado;
      fila.style.display = mostrar ? '' : 'none';
      if (mostrar) visibles++;
    });
    // Mostrar mensaje si no hay coincidencias
    let mensaje = document.getElementById(mensajeNoCoincidenciasId);
    if (visibles === 0) {
      if (!mensaje) {
        mensaje = document.createElement('tr');
        mensaje.id = mensajeNoCoincidenciasId;
        mensaje.innerHTML = `<td colspan="8" class="text-center text-danger">No hay coincidencias para el filtro actual.</td>`;
        tabla.appendChild(mensaje);
      }
    } else {
      if (mensaje) mensaje.remove();
    }
  }
  inputCliente.addEventListener('input', function() {
    filtrarTabla();
    // Pausar autorefresh si está activo
    if (typeof autoRefresh !== 'undefined' && autoRefresh) {
      autoRefresh = false;
      localStorage.setItem('dashboard_auto_refresh', autoRefresh);
      const btn = document.getElementById('toggle-auto');
      if (btn) {
        btn.innerHTML = '<i class="fas fa-play"></i>';
        btn.title = 'Activar actualización automática';
      }
      if (typeof refreshTimer !== 'undefined' && refreshTimer) clearInterval(refreshTimer);
    }
  });
  selectEstado.addEventListener('change', filtrarTabla);
  filtrarTabla();
  </script>
</div>
{% endblock %}
