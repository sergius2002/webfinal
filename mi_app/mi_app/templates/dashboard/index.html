{% extends "base.html" %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
  </ol>
</nav>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>Resumen de pedidos por cliente</h1>
  <div class="d-flex justify-content-end align-items-center mb-2" style="gap:1rem;">
    <label class="mb-0">Actualizar cada 
      <select id="refresh-interval" class="form-select form-select-sm d-inline-block w-auto" style="width:auto;">
        <option value="3">3 seg</option>
        <option value="5">5 seg</option>
        <option value="30">30 seg</option>
        <option value="60" selected>60 seg</option>
      </select>
    </label>
    <button id="refresh-manual" class="btn btn-outline-primary btn-sm" title="Actualizar ahora"><i class="fas fa-sync-alt"></i></button>
    <button id="toggle-auto" class="btn btn-outline-secondary btn-sm" title="Desactivar actualización automática"><i class="fas fa-pause"></i></button>
  </div>
  <div class="row mb-3 gy-2 gx-2 flex-column flex-md-row">
    <div class="col-12 col-md-6 mb-2 mb-md-0">
      <div class="input-group">
        <input type="text" id="filtro-cliente" class="form-control" placeholder="Buscar cliente...">
        <button class="btn btn-outline-secondary" id="btn-limpiar-filtros" type="button" title="Limpiar filtros"><i class="fas fa-eraser"></i></button>
      </div>
    </div>
    <div class="col-12 col-md-4 mb-2 mb-md-0">
      <select id="filtro-estado" class="form-select">
        <option value="">Todos los estados</option>
        <option value="deuda">Con deuda</option>
        <option value="favor">Saldo a favor</option>
        <option value="cero">Sin saldo</option>
      </select>
    </div>
    <div class="col-12 col-md-2 d-flex align-items-center justify-content-md-end mt-2 mt-md-0">
      <button class="btn btn-success w-100" id="btn-exportar" type="button"><i class="fas fa-file-excel me-1"></i>Exportar</button>
    </div>
  </div>
  <div class="card shadow-lg">
    <div class="card-body">
      <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-striped align-middle" id="tabla-dashboard" style="min-width:900px;">
          <thead style="position: sticky; top: 0; z-index: 2; background: #083366; color: white;">
            <tr>
              <th>Cliente</th>
              <th>Deuda anterior</th>
              <th>BRS</th>
              <th>Deuda de hoy</th>
              <th>Pagos</th>
              <th>Saldo Final</th>
              <th>Estado</th>
              <th>Copiar</th>
            </tr>
          </thead>
          <tbody>
            {% for r in resumen %}
            <tr data-cliente="{{ r.cliente|lower }}" data-estado="{% if r.diferencia > 0 %}deuda{% elif r.diferencia < 0 %}favor{% else %}cero{% endif %}">
              <td class="td-cliente">{{ r.cliente }}</td>
              <td>{{ r.deuda_anterior | format_int }}</td>
              <td>{{ r.brs | format_int }}</td>
              <td>{{ r.clp | format_int }}</td>
              <td class="td-pagos">{{ r.pagos | format_int }}</td>
              <td class="td-saldo-final">
                {% if r.diferencia > 0 %}
                  <span class="text-danger fw-bold px-2 py-1 rounded border border-danger shadow-sm" style="background:#ffe5e5;" title="¡Este cliente tiene deuda pendiente!">
                    <i class="fas fa-exclamation-triangle me-1"></i>{{ r.diferencia | format_int }}
                  </span>
                {% else %}
                  {{ r.diferencia | format_int }}
                {% endif %}
              </td>
              <td>
                {% if r.diferencia > 0 %}
                  <span id="estado-msg-{{ loop.index }}">Saldo pendiente {{ r.diferencia | format_int }} Clp</span>
                {% elif r.diferencia < 0 %}
                  <span id="estado-msg-{{ loop.index }}">Saldo a Favor de {{ (r.diferencia * -1) | format_int }} Clp</span>
                {% else %}
                  <span id="estado-msg-{{ loop.index }}">Sin saldo pendiente</span>
                {% endif %}
              </td>
              <td>
                <button class="btn btn-outline-secondary btn-sm" onclick="copiarEstado('estado-msg-{{ loop.index }}')" title="Copiar mensaje"><i class="fas fa-copy"></i></button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center">No hay pedidos para la fecha seleccionada.</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-info fw-bold">
              <td colspan="4" class="text-end">Totales:</td>
              <td id="total-pagos"></td>
              <td id="total-saldo-final"></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
  <style>
    @media (max-width: 768px) {
      .table-responsive { max-height: 60vh; }
      #tabla-dashboard { font-size: 0.95rem; }
      .input-group, .form-select { width: 100%; }
      .card-body { padding: 0.5rem; }
    }
    @media (max-width: 576px) {
      #tabla-dashboard { min-width: 700px; }
      .table-responsive { max-height: 50vh; }
    }
  </style>
  <script>
  function copiarEstado(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const texto = el.innerText;
    navigator.clipboard.writeText(texto).then(function() {
      el.classList.add('bg-success','text-white');
      setTimeout(() => el.classList.remove('bg-success','text-white'), 800);
    });
  }
  // Filtro en vivo por cliente y estado + resaltado y limpiar filtros
  const inputCliente = document.getElementById('filtro-cliente');
  const selectEstado = document.getElementById('filtro-estado');
  const btnLimpiar = document.getElementById('btn-limpiar-filtros');
  const btnExportar = document.getElementById('btn-exportar');
  const tabla = document.getElementById('tabla-dashboard').getElementsByTagName('tbody')[0];
  const filas = Array.from(tabla.rows);
  const mensajeNoCoincidenciasId = 'mensaje-no-coincidencias';
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  function resaltarTexto(element, texto) {
    if (!texto) {
      element.innerHTML = element.getAttribute('data-original') || element.textContent;
      return;
    }
    const original = element.getAttribute('data-original') || element.textContent;
    const regex = new RegExp('(' + escapeRegExp(texto) + ')', 'gi');
    element.innerHTML = original.replace(regex, '<mark>$1</mark>');
    element.setAttribute('data-original', original);
  }
  function filtrarTabla() {
    const texto = inputCliente.value.toLowerCase();
    const estado = selectEstado.value;
    let totalPagos = 0;
    let totalSaldoFinal = 0;
    let visibles = 0;
    filas.forEach(fila => {
      const cliente = fila.getAttribute('data-cliente') || '';
      const estadoFila = fila.getAttribute('data-estado') || '';
      const coincideCliente = cliente.includes(texto);
      const coincideEstado = !estado || estadoFila === estado;
      const mostrar = coincideCliente && coincideEstado;
      fila.style.display = mostrar ? '' : 'none';
      // Resaltar búsqueda
      const tdCliente = fila.querySelector('.td-cliente');
      if (tdCliente) resaltarTexto(tdCliente, texto);
      if (mostrar) {
        visibles++;
        // Sumar totales
        const pagos = parseFloat(fila.querySelector('.td-pagos')?.textContent.replace(/\./g, '').replace(',', '.') || 0);
        const saldo = parseFloat(fila.querySelector('.td-saldo-final')?.textContent.replace(/\./g, '').replace(',', '.') || 0);
        totalPagos += isNaN(pagos) ? 0 : pagos;
        totalSaldoFinal += isNaN(saldo) ? 0 : saldo;
      }
    });
    // Mostrar totales
    document.getElementById('total-pagos').textContent = totalPagos.toLocaleString('es-CL', {maximumFractionDigits:0});
    document.getElementById('total-saldo-final').textContent = totalSaldoFinal.toLocaleString('es-CL', {maximumFractionDigits:0});
    // Mostrar mensaje si no hay coincidencias
    let mensaje = document.getElementById(mensajeNoCoincidenciasId);
    if (visibles === 0) {
      if (!mensaje) {
        mensaje = document.createElement('tr');
        mensaje.id = mensajeNoCoincidenciasId;
        mensaje.innerHTML = `<td colspan="8" class="text-center text-danger">No hay coincidencias para el filtro actual.</td>`;
        tabla.appendChild(mensaje);
      }
    } else {
      if (mensaje) mensaje.remove();
    }
  }
  inputCliente.addEventListener('input', function() {
    filtrarTabla();
    if (typeof autoRefresh !== 'undefined' && autoRefresh) {
      autoRefresh = false;
      localStorage.setItem('dashboard_auto_refresh', autoRefresh);
      const btn = document.getElementById('toggle-auto');
      if (btn) {
        btn.innerHTML = '<i class=\'fas fa-play\'></i>';
        btn.title = 'Activar actualización automática';
      }
      if (typeof refreshTimer !== 'undefined' && refreshTimer) clearInterval(refreshTimer);
    }
  });
  selectEstado.addEventListener('change', filtrarTabla);
  btnLimpiar.addEventListener('click', function() {
    inputCliente.value = '';
    selectEstado.value = '';
    filtrarTabla();
  });
  // Exportar a CSV
  btnExportar.addEventListener('click', function() {
    let csv = '';
    const headers = Array.from(document.querySelectorAll('#tabla-dashboard thead th')).map(th => th.innerText.trim()).slice(0, -1); // sin columna copiar
    csv += headers.join(';') + '\n';
    Array.from(tabla.rows).forEach(fila => {
      if (fila.style.display === 'none') return;
      const celdas = Array.from(fila.cells).slice(0, -1); // sin columna copiar
      csv += celdas.map(td => '"' + td.innerText.replace(/"/g, '""') + '"').join(';') + '\n';
    });
    // Agregar BOM UTF-8
    const blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dashboard_clientes.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  filtrarTabla();
  </script>
</div>
{% endblock %}
