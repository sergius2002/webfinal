{% extends "base.html" %}
{% block head %}
<style>
.cliente-link:hover {
  color: #007bff !important;
  text-decoration: underline !important;
}
</style>
{% endblock %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
  </ol>
</nav>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>Resumen de pedidos por cliente</h1>
  <div class="d-flex justify-content-end align-items-center mb-2" style="gap:1rem;">
    <label class="mb-0">Actualizar cada 
      <select id="refresh-interval" class="form-select form-select-sm d-inline-block w-auto" style="width:auto;">
        <option value="3">3 seg</option>
        <option value="5">5 seg</option>
        <option value="30">30 seg</option>
        <option value="60" selected>60 seg</option>
      </select>
    </label>
    <button id="refresh-manual" class="btn btn-outline-primary btn-sm" title="Actualizar ahora"><i class="fas fa-sync-alt"></i></button>
    <button id="toggle-auto" class="btn btn-outline-secondary btn-sm" title="Desactivar actualización automática"><i class="fas fa-pause"></i></button>
  </div>
  <div class="row mb-3 gy-2 gx-2 flex-column flex-md-row">
    <div class="col-12 col-md-6 mb-2 mb-md-0">
      <div class="input-group">
        <input type="text" id="filtro-cliente" class="form-control" placeholder="Buscar cliente...">
        <button class="btn btn-outline-secondary" id="btn-limpiar-filtros" type="button" title="Limpiar filtros"><i class="fas fa-eraser"></i></button>
        <button id="btn-exportar-csv" class="btn btn-outline-success" type="button" title="Exportar a Excel">
          <i class="fas fa-file-excel"></i>
        </button>
      </div>
    </div>
    <div class="col-12 col-md-6 mb-2 mb-md-0">
      <select id="filtro-estado" class="form-select">
        <option value="">Todos los estados</option>
        <option value="deuda">Con deuda</option>
        <option value="favor">Saldo a favor</option>
        <option value="cero">Sin saldo</option>
      </select>
    </div>
  </div>
  <div class="card shadow-lg">
    <div class="card-body">
      <div id="loading-indicator" class="text-center py-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Actualizando datos...</p>
      </div>
      <table class="table table-striped align-middle" id="tabla-dashboard" style="min-width:900px;">
        <thead style="position: sticky; top: 0; z-index: 2; background: #083366; color: white;">
          <tr>
            <th class="sortable" data-col="0">Cliente <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="1">Deuda anterior <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="2">BRS <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="3">Deuda de hoy <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="4">Pagos <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="5">Saldo Final <span class="sort-arrow"></span></th>
            <th class="sortable" data-col="6">Estado <span class="sort-arrow"></span></th>
            <th>Copiar</th>
          </tr>
        </thead>
        <tbody>
          {% for r in resumen %}
          <tr data-cliente="{{ r.cliente|lower }}" data-estado="{% if r.diferencia > 0 %}deuda{% elif r.diferencia < 0 %}favor{% else %}cero{% endif %}">
            <td class="td-cliente">{{ r.cliente }}</td>
            <td>{{ r.deuda_anterior | format_int }}</td>
            <td>{{ r.brs | format_int }}</td>
            <td>{{ r.clp | format_int }}</td>
            <td class="td-pagos">{{ r.pagos | format_int }}</td>
            <td class="td-saldo-final">
              {% if r.diferencia > 0 %}
                <span class="text-danger fw-bold px-2 py-1 rounded border border-danger shadow-sm" style="background:#ffe5e5;" title="¡Este cliente tiene deuda pendiente!">
                  <i class="fas fa-exclamation-triangle me-1"></i>{{ r.diferencia | format_int }}
                </span>
              {% else %}
                {{ r.diferencia | format_int }}
              {% endif %}
            </td>
            <td>
              {% if r.diferencia > 0 %}
                <span id="estado-msg-{{ loop.index }}">Saldo pendiente {{ r.diferencia | format_int }} Clp</span>
              {% elif r.diferencia < 0 %}
                <span id="estado-msg-{{ loop.index }}">Saldo a Favor de {{ (r.diferencia * -1) | format_int }} Clp</span>
              {% else %}
                <span id="estado-msg-{{ loop.index }}">Sin saldo pendiente</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-outline-secondary btn-sm" onclick="copiarEstado('estado-msg-{{ loop.index }}')" title="Copiar mensaje"><i class="fas fa-copy"></i></button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center">No hay pedidos para la fecha seleccionada.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-info fw-bold">
            <td colspan="4" class="text-end">Totales:</td>
            <td id="total-pagos"></td>
            <td id="total-saldo-final"></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  <style>
    @media (max-width: 768px) {
      #tabla-dashboard { font-size: 0.95rem; }
      .input-group, .form-select { width: 100%; }
      .card-body { padding: 0.5rem; }
    }
    @media (max-width: 576px) {
      #tabla-dashboard { min-width: 700px; }
    }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable .sort-arrow { font-size: 0.9em; margin-left: 2px; }
  </style>
  <script>
  // Variables globales
  let dashboardData = [];
  let currentFecha = '{{ fecha }}';
  let currentCliente = '{{ cliente_filtro }}';
  let autoRefresh = true;
  let refreshTimer = null;
  let isLoading = false;

  // Función para formatear números
  function formatNumber(num) {
    return new Intl.NumberFormat('es-CL', {maximumFractionDigits: 0}).format(num);
  }

  // Función para copiar estado
  function copiarEstado(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const texto = el.innerText;
    navigator.clipboard.writeText(texto).then(function() {
      el.classList.add('bg-success','text-white');
      setTimeout(() => el.classList.remove('bg-success','text-white'), 800);
    });
  }

  // Función para cargar datos del dashboard
  async function cargarDashboard() {
    if (isLoading) return;
    isLoading = true;
    
    // Mostrar indicador de carga
    const loadingIndicator = document.getElementById('loading-indicator');
    const table = document.getElementById('tabla-dashboard');
    if (loadingIndicator && table) {
      loadingIndicator.style.display = 'block';
      table.style.opacity = '0.5';
    }
    
    try {
      const url = `/dashboard/api/datos?fecha=${currentFecha}&cliente=${currentCliente}`;
      const response = await fetch(url);
      const result = await response.json();
      
      if (result.success) {
        dashboardData = result.data;
        actualizarTabla();
        actualizarTimestamp(result.timestamp);
      } else {
        console.error('Error al cargar datos:', result.error);
        mostrarError('Error al cargar datos del dashboard');
      }
    } catch (error) {
      console.error('Error en la petición:', error);
      mostrarError('Error de conexión');
    } finally {
      isLoading = false;
      
      // Ocultar indicador de carga
      const loadingIndicator = document.getElementById('loading-indicator');
      const table = document.getElementById('tabla-dashboard');
      if (loadingIndicator && table) {
        loadingIndicator.style.display = 'none';
        table.style.opacity = '1';
      }
    }
  }

  // Función para actualizar la tabla
  function actualizarTabla() {
    const tbody = document.getElementById('tabla-dashboard').getElementsByTagName('tbody')[0];
    const tfoot = document.getElementById('tabla-dashboard').getElementsByTagName('tfoot')[0];
    
    if (dashboardData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay movimientos para la fecha seleccionada.</td></tr>';
      tfoot.style.display = 'none';
      return;
    }
    
    tfoot.style.display = '';
    let totalPagos = 0;
    let totalSaldoFinal = 0;
    
    const rows = dashboardData.map((r, index) => {
      const estado = r.diferencia > 0 ? 'deuda' : r.diferencia < 0 ? 'favor' : 'cero';
      const saldoClass = r.diferencia > 0 ? 'text-danger fw-bold px-2 py-1 rounded border border-danger shadow-sm' : '';
      const saldoStyle = r.diferencia > 0 ? 'background:#ffe5e5;' : '';
      const saldoIcon = r.diferencia > 0 ? '<i class="fas fa-exclamation-triangle me-1"></i>' : '';
      
      totalPagos += r.pagos;
      totalSaldoFinal += r.diferencia;
      
      return `
        <tr data-cliente="${r.cliente.toLowerCase()}" data-estado="${estado}">
          <td class="td-cliente">
            <a href="#" class="cliente-link" data-cliente="${r.cliente}" style="text-decoration: none; color: inherit; cursor: pointer;">
              ${r.cliente}
            </a>
          </td>
          <td>${formatNumber(r.deuda_anterior)}</td>
          <td>${formatNumber(r.brs)}</td>
          <td>${formatNumber(r.clp)}</td>
          <td class="td-pagos">${formatNumber(r.pagos)}</td>
          <td class="td-saldo-final">
            ${r.diferencia > 0 ? 
              `<span class="${saldoClass}" style="${saldoStyle}" title="¡Este cliente tiene deuda pendiente!">${saldoIcon}${formatNumber(r.diferencia)}</span>` : 
              formatNumber(r.diferencia)
            }
          </td>
          <td>
            <span id="estado-msg-${index + 1}">
              ${r.diferencia > 0 ? 
                `Saldo pendiente ${formatNumber(r.diferencia)} Clp` : 
                r.diferencia < 0 ? 
                `Saldo a Favor de ${formatNumber(Math.abs(r.diferencia))} Clp` : 
                'Sin saldo pendiente'
              }
            </span>
          </td>
          <td>
            <button class="btn btn-outline-secondary btn-sm" onclick="copiarEstado('estado-msg-${index + 1}')" title="Copiar mensaje">
              <i class="fas fa-copy"></i>
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows;
    
    // Actualizar totales
    document.getElementById('total-pagos').textContent = formatNumber(totalPagos);
    document.getElementById('total-saldo-final').textContent = formatNumber(totalSaldoFinal);
    
    // Aplicar filtros si existen
    aplicarFiltros();
    
    // Agregar event listeners para los enlaces de clientes
    document.querySelectorAll('.cliente-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const cliente = this.getAttribute('data-cliente');
        abrirModalCliente(cliente);
      });
    });
  }

  // Función para aplicar filtros
  function aplicarFiltros() {
    const inputCliente = document.getElementById('filtro-cliente');
    const selectEstado = document.getElementById('filtro-estado');
    const texto = inputCliente.value.toLowerCase();
    const estado = selectEstado.value;
    
    const filas = document.querySelectorAll('#tabla-dashboard tbody tr');
    let visibles = 0;
    
    filas.forEach(fila => {
      const cliente = fila.getAttribute('data-cliente') || '';
      const estadoFila = fila.getAttribute('data-estado') || '';
      const coincideCliente = cliente.includes(texto);
      const coincideEstado = !estado || estadoFila === estado;
      const mostrar = coincideCliente && coincideEstado;
      
      fila.style.display = mostrar ? '' : 'none';
      
      if (mostrar) {
        visibles++;
        // Quitar resaltado: solo mostrar el texto plano del enlace
        const linkCliente = fila.querySelector('.cliente-link');
        if (linkCliente) {
          linkCliente.textContent = linkCliente.getAttribute('data-cliente');
        }
      }
    });
    
    // Mostrar mensaje si no hay coincidencias
    let mensaje = document.getElementById('mensaje-no-coincidencias');
    if (visibles === 0 && (texto || estado)) {
      if (!mensaje) {
        mensaje = document.createElement('tr');
        mensaje.id = 'mensaje-no-coincidencias';
        mensaje.innerHTML = '<td colspan="8" class="text-center text-danger">No hay coincidencias para el filtro actual.</td>';
        document.querySelector('#tabla-dashboard tbody').appendChild(mensaje);
      }
    } else {
      if (mensaje) mensaje.remove();
    }

    // Volver a asignar el evento a los enlaces de cliente después de filtrar
    document.querySelectorAll('.cliente-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const cliente = this.getAttribute('data-cliente');
        abrirModalCliente(cliente);
      });
    });
  }

  // Función para mostrar error
  function mostrarError(mensaje) {
    const tbody = document.getElementById('tabla-dashboard').getElementsByTagName('tbody')[0];
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">${mensaje}</td></tr>`;
  }

  // Función para actualizar timestamp
  function actualizarTimestamp(timestamp) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-CL');
    document.title = `Dashboard - Actualizado: ${timeStr}`;
  }

  // Función para abrir modal de cliente
  async function abrirModalCliente(cliente) {
    const modal = new bootstrap.Modal(document.getElementById('clienteModal'));
    const modalTitle = document.getElementById('clienteModalLabel');
    const modalLoading = document.getElementById('modalLoading');
    const modalContent = document.getElementById('modalContent');
    
    // Configurar modal
    modalTitle.textContent = `Detalles de ${cliente}`;
    modalLoading.style.display = 'block';
    modalContent.style.display = 'none';
    
    // Configurar botones
    document.getElementById('btnVerDetalles').href = `/dashboard/detalle/${encodeURIComponent(cliente)}`;
    document.getElementById('btnNuevoPedido').href = `/pedidos/?cliente=${encodeURIComponent(cliente)}`;
    document.getElementById('btnNuevoPago').href = `/pagos/?cliente=${encodeURIComponent(cliente)}`;
    
    modal.show();
    
    try {
      // Cargar datos del cliente
      const response = await fetch(`/dashboard/api/cliente/${encodeURIComponent(cliente)}`);
      const data = await response.json();
      
      if (data.success) {
        // Ocultar loading y mostrar contenido
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
        // Actualizar resumen
        document.getElementById('modalDeudaAnterior').textContent = formatNumber(data.resumen.deuda_anterior);
        document.getElementById('modalPedidosHoy').textContent = formatNumber(data.resumen.pedidos_hoy);
        document.getElementById('modalPagosHoy').textContent = formatNumber(data.resumen.pagos_hoy);
        document.getElementById('modalSaldoFinal').textContent = formatNumber(data.resumen.saldo_final);
        
        // Actualizar tabla de pedidos
        const tbodyPedidos = document.getElementById('modalPedidos');
        if (data.pedidos.length > 0) {
          tbodyPedidos.innerHTML = data.pedidos.map(p => `
            <tr>
              <td>${p.fecha}</td>
              <td>${formatNumber(p.brs)}</td>
              <td>${formatNumber(p.clp)}</td>
            </tr>
          `).join('');
        } else {
          tbodyPedidos.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay pedidos recientes</td></tr>';
        }
        
        // Actualizar tabla de pagos
        const tbodyPagos = document.getElementById('modalPagos');
        if (data.pagos.length > 0) {
          tbodyPagos.innerHTML = data.pagos.map(p => `
            <tr>
              <td>${p.fecha}</td>
              <td>${formatNumber(p.monto)}</td>
            </tr>
          `).join('');
        } else {
          tbodyPagos.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No hay pagos recientes</td></tr>';
        }
        
      } else {
        throw new Error(data.error || 'Error al cargar datos del cliente');
      }
      
    } catch (error) {
      console.error('Error:', error);
      modalLoading.innerHTML = `
        <div class="text-center py-3">
          <div class="text-danger">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p>Error al cargar los datos del cliente</p>
            <small>${error.message}</small>
          </div>
        </div>
      `;
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    const inputCliente = document.getElementById('filtro-cliente');
    const selectEstado = document.getElementById('filtro-estado');
    const btnLimpiar = document.getElementById('btn-limpiar-filtros');
    const refreshInterval = document.getElementById('refresh-interval');
    const refreshManual = document.getElementById('refresh-manual');
    const toggleAuto = document.getElementById('toggle-auto');
    const btnExportarCsv = document.getElementById('btn-exportar-csv');

    // Filtros
    inputCliente.addEventListener('input', aplicarFiltros);
    selectEstado.addEventListener('change', aplicarFiltros);
    
    btnLimpiar.addEventListener('click', function() {
      inputCliente.value = '';
      selectEstado.value = '';
      aplicarFiltros();
    });

    // Actualización automática
    refreshManual.addEventListener('click', async function() {
      // Limpiar caché antes de recargar
      try {
        await fetch('/dashboard/limpiar_cache', { method: 'POST' });
      } catch (e) { /* ignorar error */ }
      cargarDashboard();
    });
    
    toggleAuto.addEventListener('click', function() {
      autoRefresh = !autoRefresh;
      localStorage.setItem('dashboard_auto_refresh', autoRefresh);
      
      if (autoRefresh) {
        this.innerHTML = '<i class="fas fa-pause"></i>';
        this.title = 'Desactivar actualización automática';
        iniciarAutoRefresh();
      } else {
        this.innerHTML = '<i class="fas fa-play"></i>';
        this.title = 'Activar actualización automática';
        if (refreshTimer) clearInterval(refreshTimer);
      }
    });

    refreshInterval.addEventListener('change', function() {
      if (autoRefresh) {
        if (refreshTimer) clearInterval(refreshTimer);
        iniciarAutoRefresh();
      }
    });

    // Exportar CSV
    btnExportarCsv.addEventListener('click', function() {
      const url = `/dashboard/exportar-csv?fecha=${currentFecha}&cliente=${currentCliente}`;
      
      // Efecto visual de feedback
      this.classList.add('btn-success');
      this.classList.remove('btn-outline-success');
      this.innerHTML = '<i class="fas fa-check"></i>';
      
      // Crear un enlace temporal para descargar el archivo
      const link = document.createElement('a');
      link.href = url;
      link.download = `dashboard_${currentFecha}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Restaurar el botón después de 1 segundo
      setTimeout(() => {
        this.classList.remove('btn-success');
        this.classList.add('btn-outline-success');
        this.innerHTML = '<i class="fas fa-file-excel"></i>';
      }, 1000);
    });

    function iniciarAutoRefresh() {
      const interval = parseInt(refreshInterval.value) * 1000;
      refreshTimer = setInterval(cargarDashboard, interval);
    }

         // Cargar datos iniciales
     cargarDashboard();
     
     // Iniciar auto-refresh si está habilitado
     if (autoRefresh) {
       iniciarAutoRefresh();
     }
        });
  </script>
</div>

<!-- Modal de detalles del cliente -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clienteModalLabel">Detalles del Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalLoading" class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando detalles...</p>
        </div>
        
        <div id="modalContent" style="display: none;">
          <!-- Resumen de deuda -->
          <div class="row mb-4">
            <div class="col-md-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Resumen de Deuda</h6>
                  <div class="row">
                    <div class="col-md-3">
                      <small class="text-muted">Deuda Anterior</small>
                      <div class="fw-bold" id="modalDeudaAnterior">$0</div>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted">Pedidos Hoy</small>
                      <div class="fw-bold text-primary" id="modalPedidosHoy">$0</div>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted">Pagos Hoy</small>
                      <div class="fw-bold text-success" id="modalPagosHoy">$0</div>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted">Saldo Final</small>
                      <div class="fw-bold" id="modalSaldoFinal">$0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Pedidos recientes -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h6>Pedidos Recientes</h6>
              <div class="table-responsive" style="max-height: 300px;">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr>
                      <th>Fecha</th>
                      <th>BRS</th>
                      <th>CLP</th>
                    </tr>
                  </thead>
                  <tbody id="modalPedidos">
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Pagos recientes -->
            <div class="col-md-6">
              <h6>Pagos Recientes</h6>
              <div class="table-responsive" style="max-height: 300px;">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr>
                      <th>Fecha</th>
                      <th>Monto</th>
                    </tr>
                  </thead>
                  <tbody id="modalPagos">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a href="#" id="btnVerDetalles" class="btn btn-primary">Ver más detalles</a>
        <a href="#" id="btnNuevoPedido" class="btn btn-success">Nuevo Pedido</a>
        <a href="#" id="btnNuevoPago" class="btn btn-warning">Nuevo Pago</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}
