{% extends "base.html" %}
{% block title %}Transferencias{% endblock %}

{% block content %}
<div class="container">
  <h1 class="mb-4">Transferencias</h1>
  <div class="d-flex gap-3 mb-4">
    <a href="{{ url_for('transferencias.nuevo') }}" class="btn btn-success" style="font-weight:600; font-size:1.1rem;">
      <i class="fas fa-plus me-2"></i>Nueva Transferencia
    </a>
    <button type="button" class="btn btn-info" style="font-weight:600; font-size:1.1rem;" data-bs-toggle="modal" data-bs-target="#modalSubirArchivo">
      <i class="fas fa-upload me-2"></i>Subir Archivo
    </button>
    <a href="{{ url_for('transferencias.historial_archivos') }}" class="btn btn-secondary" style="font-weight:600; font-size:1.1rem;">
      <i class="fas fa-history me-2"></i>Historial Archivos
    </a>
  </div>

  <!-- Filtros en tiempo real -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg" style="border-radius: 18px; background: #fff;">
        <div class="card-header" style="font-size:1.15rem; color:#0a2c53; background:#f4f6fa; border-radius: 18px 18px 0 0; font-weight:600; letter-spacing:0.5px;">
          <i class="fas fa-filter me-2"></i>Filtros en Tiempo Real
        </div>
        <div class="card-body p-4">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label for="filtro-cliente" class="form-label" style="font-size:0.98rem; color:#333;">
                <i class="fas fa-user me-1"></i>Cliente
              </label>
              <input type="text" id="filtro-cliente" class="form-control" placeholder="Buscar cliente..." style="border-radius:10px;">
            </div>
            <div class="col-md-3">
              <label for="filtro-empresa" class="form-label" style="font-size:0.98rem; color:#333;">
                <i class="fas fa-building me-1"></i>Empresa
              </label>
              <input type="text" id="filtro-empresa" class="form-control" placeholder="Buscar empresa..." style="border-radius:10px;">
            </div>
            <div class="col-md-2">
              <label for="filtro-rut" class="form-label" style="font-size:0.98rem; color:#333;">
                <i class="fas fa-id-card me-1"></i>RUT
              </label>
              <input type="text" id="filtro-rut" class="form-control" placeholder="Buscar RUT..." style="border-radius:10px;">
            </div>
            <div class="col-md-2">
              <label for="filtro-monto" class="form-label" style="font-size:0.98rem; color:#333;">
                <i class="fas fa-dollar-sign me-1"></i>Monto
              </label>
              <input type="text" id="filtro-monto" class="form-control" placeholder="Buscar monto..." style="border-radius:10px;">
            </div>
            <div class="col-md-2">
              <label for="filtro-asignado" class="form-label" style="font-size:0.98rem; color:#333;">
                <i class="fas fa-check-circle me-1"></i>Estado
              </label>
              <select id="filtro-asignado" class="form-select" style="border-radius:10px;">
                <option value="">Todos</option>
                <option value="asignado">Asignadas</option>
                <option value="no-asignado">No asignadas</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button id="btn-ocultar-empresas" class="btn btn-outline-dark w-100" type="button">
                <i class="fas fa-eye-slash me-1"></i>Ocultar empresas
              </button>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12 d-flex justify-content-between align-items-center">
              <div class="d-flex gap-2">
                <button id="btn-limpiar-filtros" class="btn btn-outline-secondary" type="button" title="Limpiar filtros">
                  <i class="fas fa-eraser me-1"></i>Limpiar filtros
                </button>
                <span id="contador-resultados" class="badge bg-info align-self-center" style="font-size:0.9rem;">
                  {{ transfers|length }} transferencias
                </span>
              </div>
              <div class="d-flex gap-2">
                <button id="btn-exportar-csv" class="btn btn-outline-success" type="button" title="Exportar a Excel">
                  <i class="fas fa-file-excel me-1"></i>Exportar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de resultados -->
  <table class="table table-striped mt-4" id="tabla-transferencias">
    <thead class="sticky-header">
      <tr>
        <th>Cliente</th>
        <th class="text-end">Monto</th>
        <th>Empresa</th>
        <th>Rut</th>
        <th>Fecha</th>
        <th>Fecha Detec</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% if transfers|length == 0 %}
        <tr><td colspan="7" class="text-center text-muted">No hay transferencias para mostrar.</td></tr>
      {% else %}
      {% for t in transfers %}
      <tr id="row-{{ t.id }}" 
          data-cliente="{{ t.cliente|lower }}" 
          data-empresa="{{ t.empresa|lower }}" 
          data-rut="{{ t.rut|lower }}" 
          data-monto="{{ t.monto }}" 
          data-asignado="{{ 'asignado' if t.asignado else 'no-asignado' }}">
        <td class="td-cliente">{{ t.cliente }}</td>
        <td class="text-end td-monto">{{ t.monto | format_monto }}</td>
        <td class="td-empresa">{{ t.empresa }}</td>
        <td class="td-rut">{{ t.rut }}</td>
        <td class="td-fecha">{{ t.fecha | format_date }}</td>
        <td class="td-fecha-detec">{{ t.fecha_detec | format_fecha_detec }}</td>
        <td>
          {% if t.manual %}
            <a href="{{ url_for('transferencias.editar_transferencia', transfer_id=t.id) }}" class="btn btn-sm btn-warning">Editar</a>
          {% endif %}
          <!-- Dropdown de clientes (siempre visible con Select2) -->
          <div class="asignar-pago-dropdown mt-2 d-flex align-items-center gap-2" id="dropdown-{{ t.id }}" style="display:block; min-width:220px;">
            <select class="js-example-basic-single form-select form-select-sm" name="cliente" data-transfer-id="{{ t.id }}" style="width: 160px; min-width: 120px;" {% if t.asignado %}disabled{% endif %}>
              {% if t.cliente == 'Desconocido' %}
                <option value="" selected disabled>Seleccionar cliente</option>
              {% endif %}
              {% for client in cliente %}
                <option value="{{ client }}" {% if client == t.cliente and t.cliente != 'Desconocido' %}selected{% endif %}>{{ client }}</option>
              {% endfor %}
            </select>
            {% if t.asignado %}
              <button class="btn btn-sm btn-danger d-flex align-items-center" type="button" disabled title="Esta transferencia ya fue asignada">
                <i class="fas fa-check me-1"></i>Asignado
              </button>
            {% else %}
              <button class="btn btn-sm btn-primary asignar-pago-confirmar" type="button" data-transfer-id="{{ t.id }}">
                Asignar pago
              </button>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
      {% endif %}
    </tbody>
  </table>
  
  <!-- Información de paginación y filtros -->
  <div class="row mt-3">
    <div class="col-md-6">
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Filtro automático:</strong> Mostrando solo transferencias de los últimos 15 días
        <br>
        <small class="text-muted">
          Página {{ pagination.page }} de {{ pagination.total_pages }} 
          ({{ pagination.total_records }} registros totales, {{ pagination.per_page }} por página)
        </small>
      </div>
    </div>
  </div>
  
  <!-- Controles de paginación -->
  {% if pagination.total_pages > 1 %}
  {% set args = request.args.to_dict() %}
  {% if 'page' in args %}{% set _ = args.pop('page') %}{% endif %}
  <nav aria-label="Navegación de páginas" class="mt-3">
    <ul class="pagination justify-content-center">
      <!-- Botón Anterior -->
      {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link btn btn-sm" href="{{ url_for('transferencias.index', page=pagination.prev_page, **args) }}" aria-label="Anterior">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link btn btn-sm" aria-hidden="true">&laquo;</span>
        </li>
      {% endif %}
      
      <!-- Números de página -->
      {% set start_page = [1, pagination.page - 2] | max %}
      {% set end_page = [pagination.total_pages, pagination.page + 2] | min %}
      
      {% if start_page > 1 %}
        <li class="page-item">
          <a class="page-link btn btn-sm" href="{{ url_for('transferencias.index', page=1, **args) }}">1</a>
        </li>
        {% if start_page > 2 %}
          <li class="page-item disabled">
            <span class="page-link btn btn-sm">...</span>
          </li>
        {% endif %}
      {% endif %}
      
      {% for page_num in range(start_page, end_page + 1) %}
        {% if page_num == pagination.page %}
          <li class="page-item active">
            <span class="page-link btn btn-sm">{{ page_num }}</span>
          </li>
        {% else %}
          <li class="page-item">
            <a class="page-link btn btn-sm" href="{{ url_for('transferencias.index', page=page_num, **args) }}">{{ page_num }}</a>
          </li>
        {% endif %}
      {% endfor %}
      
      {% if end_page < pagination.total_pages %}
        {% if end_page < pagination.total_pages - 1 %}
          <li class="page-item disabled">
            <span class="page-link btn btn-sm">...</span>
          </li>
        {% endif %}
        <li class="page-item">
          <a class="page-link btn btn-sm" href="{{ url_for('transferencias.index', page=pagination.total_pages, **args) }}">{{ pagination.total_pages }}</a>
        </li>
      {% endif %}
      
      <!-- Botón Siguiente -->
      {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link btn btn-sm" href="{{ url_for('transferencias.index', page=pagination.next_page, **args) }}" aria-label="Siguiente">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link btn btn-sm" aria-hidden="true">&raquo;</span>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- Modal para subir archivo -->
<div class="modal fade" id="modalSubirArchivo" tabindex="-1" aria-labelledby="modalSubirArchivoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="modalSubirArchivoLabel">
          <i class="fas fa-upload me-2"></i>Subir Archivo de Transferencias
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
                  <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Formato requerido:</strong> El archivo debe ser un XLSX con formato de cartola bancaria.
            <ul class="mb-0 mt-2">
              <li><strong>BCI:</strong> Archivos que contengan "Movimientos_Detallado_Cuenta" en el nombre</li>
              <li><strong>Santander:</strong> Archivos que contengan "CartolaMovimiento-" en el nombre</li>
              <li><strong>Formato:</strong> Solo archivos Excel (.xlsx)</li>
              <li><strong>Procesamiento:</strong> Se ejecutará automáticamente el script correspondiente</li>
            </ul>
          </div>
        
        <form id="formSubirArchivo" enctype="multipart/form-data">
                      <div class="mb-3">
              <label for="archivo" class="form-label">Seleccionar archivo Excel:</label>
              <input type="file" class="form-control" id="archivo" name="archivo" accept=".xlsx" required>
              <div class="form-text">Máximo 10MB. Solo archivos Excel (.xlsx).</div>
            </div>
          
          <div class="mb-3">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Procesamiento Automático:</strong> El archivo será procesado automáticamente según el banco detectado.
            </div>
          </div>
        </form>
        
        <div id="previewArchivo" class="mt-3" style="display: none;">
          <h6>Vista previa del archivo:</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered" id="tablaPreview">
              <thead class="table-light">
                <tr></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-info" id="btnSubirArchivo" disabled>
          <i class="fas fa-upload me-2"></i>Subir Archivo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación de asignación de pago -->
<div class="modal fade" id="modalAsignarPago" tabindex="-1" aria-labelledby="modalAsignarPagoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="modalAsignarPagoLabel"><i class="fas fa-exclamation-triangle me-2"></i>Advertencia: Asignar pago</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>Vas a asignar un pago de <strong id="modal-monto"></strong> al cliente <strong id="modal-cliente"></strong>.</p>
        <p>Fecha y hora de la transferencia: <strong id="modal-fecha"></strong></p>
        <div class="alert alert-warning mt-3" role="alert">
          ¿Deseas continuar con la asignación de este pago?
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-warning" id="btn-confirmar-asignacion">Continuar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ocultar Empresas -->
<div class="modal fade" id="modalEmpresas" tabindex="-1" aria-labelledby="modalEmpresasLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEmpresasLabel"><i class="fas fa-eye-slash me-2"></i>Empresas a ocultar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="form-ocultar-empresas">
          <div class="mb-2">
            <small class="text-muted">Marca las empresas que NO quieres ver en la tabla:</small>
          </div>
          <div class="row">
            {% for emp in empresas %}
              {% if emp != "Todas" %}
              <div class="col-6 mb-2">
                <div class="form-check">
                  <input class="form-check-input chk-empresa-ocultar" type="checkbox" value="{{ emp }}" id="chk-emp-{{ loop.index }}">
                  <label class="form-check-label" for="chk-emp-{{ loop.index }}">{{ emp }}</label>
                </div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-aplicar-ocultar-empresas">Aplicar</button>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

<script>
$(document).ready(function(){
  // Inicializar Select2 para el filtro de Cliente
  $('#cliente').select2({
    width: '100%',
    placeholder: 'Seleccione un cliente',
    allowClear: true,
    minimumResultsForSearch: 0
  });

  // Foco automático en el campo de búsqueda al abrir el select de cliente
  $('#cliente').on('select2:open', function (e) {
    setTimeout(function() {
      document.querySelector('.select2-container--open .select2-search__field').focus();
    }, 0);
  });

  // Inicializar Select2 para el filtro de Empresas
  $('#empresa').select2({
    width: '100%',
    placeholder: 'Seleccione una o más empresas',
    allowClear: true,
    closeOnSelect: false,
    multiple: true,
    maximumSelectionLength: 5,
    language: {
      maximumSelected: function (e) {
        return 'Máximo 5 empresas seleccionadas';
      },
      noResults: function() {
        return "No se encontraron empresas";
      }
    },
    templateResult: function(data) {
      if (!data.id) return data.text; // Opción "Todas"
      return $('<span><i class="fas fa-building me-2"></i>' + data.text + '</span>');
    }
  });

  // Manejo de la opción "Todas"
  $('#empresa').on('select2:select', function(e) {
    if (e.params.data.id === '') {
      // Si se selecciona "Todas", deseleccionar las demás
      $(this).val('').trigger('change');
    } else {
      // Si se selecciona una empresa específica, deseleccionar "Todas"
      var values = $(this).val();
      if (values && values.includes('')) {
        values = values.filter(function(value) { return value !== ''; });
        $(this).val(values).trigger('change');
      }
    }
  });

  // Agregar tooltip para mostrar instrucciones
  $('#empresa').tooltip({
    title: 'Haz clic en cada empresa que desees seleccionar',
    placement: 'top',
    trigger: 'focus'
  });

  // Resetear página a 1 cuando se apliquen filtros
  $('#filtros-form').on('submit', function() {
    $('#page-reset').val('1');
  });

  // Manejo de los formularios para actualizar (Ajax)
  $("form.update-form").submit(function(event){
    event.preventDefault();
    var form = $(this);
    var url = form.attr("action");
    var nuevo_valor = form.find("input[name='nuevo_valor']").val();
    $.ajax({
      url: url,
      type: "POST",
      data: { nuevo_valor: nuevo_valor },
      headers: { "X-Requested-With": "XMLHttpRequest" },
      success: function(response){
        var row = form.closest("tr");
        var checkbox = row.find("input[type='checkbox']");
        var button = form.find("button");
        if(nuevo_valor == "1"){
          checkbox.prop("checked", true);
          button.text("Desmarcar");
          form.find("input[name='nuevo_valor']").val("0");
        } else {
          checkbox.prop("checked", false);
          button.text("Marcar");
          form.find("input[name='nuevo_valor']").val("1");
        }
        toastr.success("Registro actualizado exitosamente.");
      },
      error: function(xhr, status, error){
        toastr.error("Error al actualizar: " + error);
      }
    });
  });

  // Mostrar/ocultar el dropdown de asignar pago (robusto y con log)
  $(document).on('click', '.asignar-pago-btn', function(){
    var transferId = $(this).data('transfer-id');
    console.log('Botón Asignar pago clickeado para transferencia:', transferId);
    $('.asignar-pago-dropdown').hide(); // Oculta todos
    $('#dropdown-' + transferId).toggle(); // Muestra solo el correspondiente
  });

  // Inicializar Select2 en todos los dropdowns de clientes (búsqueda local, siempre visible)
  $('.js-example-basic-single').select2({
    minimumResultsForSearch: 0,
    width: '100%',
    placeholder: 'Buscar cliente...'
  });

  let transferenciaSeleccionada = null;
  let clienteSeleccionado = null;

  // Al hacer clic en 'Asignar pago', mostrar el modal de confirmación
  $(document).on('click', '.asignar-pago-confirmar', function(){
    var row = $(this).closest('tr');
    transferenciaSeleccionada = row.data('transfer-id') || row.attr('id').replace('row-', '');
    var dropdown = $(this).siblings('.js-example-basic-single');
    clienteSeleccionado = dropdown.val();
    var clienteTexto = dropdown.find('option:selected').text();
    var monto = row.find('td').eq(1).text().trim();
    var fecha = row.find('td').eq(5).text().trim();
    $('#modal-monto').text(monto);
    $('#modal-cliente').text(clienteTexto);
    $('#modal-fecha').text(fecha);
    var modal = new bootstrap.Modal(document.getElementById('modalAsignarPago'));
    modal.show();
  });

  // Al confirmar en el modal, enviar la petición AJAX
  $('#btn-confirmar-asignacion').on('click', function(){
    var transferId = transferenciaSeleccionada;
    var cliente = clienteSeleccionado;
    if (!cliente) {
      toastr.error('Debes seleccionar un cliente.');
      return;
    }
    
    $.ajax({
      url: '/transferencias/asignar_pago',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ 
        transferencia_id: transferId, 
        cliente: cliente 
      }),
      success: function(response) {
        if (response.success) {
          toastr.success(response.message || 'Pago asignado correctamente.');
          var modal = bootstrap.Modal.getInstance(document.getElementById('modalAsignarPago'));
          modal.hide();
          // Animación de resaltado antes de eliminar la fila
          var row = $('#row-' + transferId);
          row.addClass('resaltado-animado');
          setTimeout(function() {
            row.fadeOut(400, function() { $(this).remove(); });
          }, 600);
        } else {
          toastr.error(response.message || 'Error al asignar el pago.');
        }
      },
      error: function(xhr) {
        var errorMsg = 'Error al asignar el pago.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMsg = xhr.responseJSON.message;
          if (errorMsg.includes('ya tiene un pago asignado')) {
            errorMsg = 'Pago duplicado, no se asignará';
          }
        } else if (xhr.statusText) {
          errorMsg += ' ' + xhr.statusText;
        }
        toastr.error(errorMsg);
      }
    });
  });

  toastr.options = {
    "positionClass": "toast-top-right",
    "timeOut": "3000"
  };

  // Foco automático en el campo de búsqueda al abrir cualquier select2 de cliente en la tabla
  $(document).on('select2:open', function(e) {
    setTimeout(function() {
      document.querySelector('.select2-container--open .select2-search__field').focus();
    }, 0);
  });

  // Funcionalidad para subir archivo
  $('#archivo').on('change', function() {
    const file = this.files[0];
    const btnSubir = $('#btnSubirArchivo');
    
    if (file) {
      // Validar tipo de archivo
      if (file.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' && !file.name.endsWith('.xlsx')) {
        toastr.error('Por favor selecciona un archivo Excel (.xlsx) válido.');
        this.value = '';
        btnSubir.prop('disabled', true);
        return;
      }
      
      // Validar tamaño (10MB)
      if (file.size > 10 * 1024 * 1024) {
        toastr.error('El archivo es demasiado grande. Máximo 10MB.');
        this.value = '';
        btnSubir.prop('disabled', true);
        return;
      }
      
      // Mostrar información del archivo
      const tabla = $('#tablaPreview');
      const thead = tabla.find('thead tr');
      const tbody = tabla.find('tbody');
      
      // Limpiar tabla
      thead.empty();
      tbody.empty();
      
      // Agregar información del archivo
      thead.append('<th>Información del Archivo</th>');
      thead.append('<th>Valor</th>');
      
      const row1 = $('<tr>');
      row1.append('<td><strong>Nombre:</strong></td>');
      row1.append(`<td>${file.name}</td>`);
      tbody.append(row1);
      
      const row2 = $('<tr>');
      row2.append('<td><strong>Tamaño:</strong></td>');
      row2.append(`<td>${(file.size / 1024 / 1024).toFixed(2)} MB</td>`);
      tbody.append(row2);
      
      const row3 = $('<tr>');
      row3.append('<td><strong>Tipo:</strong></td>');
      row3.append('<td>Archivo Excel (.xlsx)</td>');
      tbody.append(row3);
      
      // Detectar tipo de banco
      let tipoBanco = 'No reconocido';
      if (file.name.includes('Movimientos_Detallado_Cuenta')) {
        tipoBanco = 'BCI';
      } else if (file.name.includes('CartolaMovimiento-')) {
        tipoBanco = 'Santander';
      }
      
      const row4 = $('<tr>');
      row4.append('<td><strong>Banco Detectado:</strong></td>');
      row4.append(`<td><span class="badge bg-info">${tipoBanco}</span></td>`);
      tbody.append(row4);
      
      $('#previewArchivo').show();
      btnSubir.prop('disabled', false);
    } else {
      btnSubir.prop('disabled', true);
      $('#previewArchivo').hide();
    }
  });

  // Manejar envío del archivo
  $('#btnSubirArchivo').on('click', function() {
    const formData = new FormData();
    const file = $('#archivo')[0].files[0];
    
    if (!file) {
      toastr.error('Por favor selecciona un archivo.');
      return;
    }
    
    formData.append('archivo', file);
    
    // Deshabilitar botón y mostrar loading
    const btn = $(this);
    const originalText = btn.html();
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Subiendo...');
    
    $.ajax({
      url: '/transferencias/subir_archivo',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        if (response.success) {
          toastr.success(response.message);
          // Cerrar modal y recargar página
          $('#modalSubirArchivo').modal('hide');
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          toastr.error(response.message || 'Error al subir el archivo.');
        }
      },
      error: function(xhr) {
        let errorMsg = 'Error al subir el archivo.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMsg = xhr.responseJSON.message;
        }
        toastr.error(errorMsg);
      },
      complete: function() {
        // Restaurar botón
        btn.prop('disabled', false).html(originalText);
      }
    });
  });

  // Limpiar formulario cuando se cierre el modal
  $('#modalSubirArchivo').on('hidden.bs.modal', function() {
    $('#formSubirArchivo')[0].reset();
    $('#previewArchivo').hide();
    $('#btnSubirArchivo').prop('disabled', true);
  });

  // ===== FILTROS EN TIEMPO REAL =====
  
  // Función para aplicar filtros en tiempo real
  function aplicarFiltrosTiempoReal() {
    const filtroCliente = $('#filtro-cliente').val().toLowerCase();
    const filtroEmpresa = $('#filtro-empresa').val().toLowerCase();
    const filtroRut = $('#filtro-rut').val().toLowerCase();
    const filtroMonto = $('#filtro-monto').val().toLowerCase();
    const filtroAsignado = $('#filtro-asignado').val();
    const filas = $('#tabla-transferencias tbody tr');
    let visibles = 0;
    let empresasOcultas = [];

    // Obtener empresas a ocultar
    $('.chk-empresa-ocultar:checked').each(function() {
      empresasOcultas.push($(this).val().toLowerCase());
    });

    filas.each(function() {
      const fila = $(this);
      const cliente = fila.data('cliente') || '';
      const empresa = fila.data('empresa') || '';
      const rut = fila.data('rut') || '';
      const monto = fila.data('monto') || '';
      const asignado = fila.data('asignado') || '';
      
      // Ocultar si la empresa está en la lista de ocultas
      const ocultarEmpresa = empresasOcultas.includes(empresa);
      
      // Aplicar filtros
      const coincideCliente = cliente.includes(filtroCliente);
      const coincideEmpresa = empresa.includes(filtroEmpresa);
      const coincideRut = rut.includes(filtroRut);
      const coincideMonto = monto.toString().includes(filtroMonto);
      const coincideAsignado = !filtroAsignado || asignado === filtroAsignado;
      
      const mostrar = coincideCliente && coincideEmpresa && coincideRut && coincideMonto && coincideAsignado && !ocultarEmpresa;
      
      if (mostrar) {
        fila.show();
        visibles++;
        
        // Resaltar texto buscado en cliente
        if (filtroCliente) {
          const tdCliente = fila.find('.td-cliente');
          const textoOriginal = tdCliente.text();
          const textoResaltado = textoOriginal.replace(
            new RegExp(filtroCliente, 'gi'),
            match => `<mark style="background-color: #ffeb3b; padding: 1px 2px; border-radius: 2px;">${match}</mark>`
          );
          tdCliente.html(textoResaltado);
        }
      } else {
        fila.hide();
      }
    });
    
    // Actualizar contador
    $('#contador-resultados').text(`${visibles} transferencias`);
    
    // Mostrar mensaje si no hay coincidencias
    let mensaje = $('#mensaje-no-coincidencias');
    if (visibles === 0 && (filtroCliente || filtroEmpresa || filtroRut || filtroMonto || filtroAsignado || empresasOcultas.length > 0)) {
      if (mensaje.length === 0) {
        mensaje = $('<tr id="mensaje-no-coincidencias"><td colspan="7" class="text-center text-danger"><i class="fas fa-search me-2"></i>No hay transferencias que coincidan con los filtros aplicados.</td></tr>');
        $('#tabla-transferencias tbody').append(mensaje);
      }
    } else {
      mensaje.remove();
    }
  }
  
  // Event listeners para filtros en tiempo real
  $('#filtro-cliente, #filtro-empresa, #filtro-rut, #filtro-monto').on('input', function() {
    aplicarFiltrosTiempoReal();
  });
  
  $('#filtro-asignado').on('change', function() {
    aplicarFiltrosTiempoReal();
  });
  
  // Botón limpiar filtros
  $('#btn-limpiar-filtros').on('click', function() {
    $('#filtro-cliente, #filtro-empresa, #filtro-rut, #filtro-monto').val('');
    $('#filtro-asignado').val('');
    aplicarFiltrosTiempoReal();
    
    // Efecto visual de feedback
    $(this).addClass('btn-secondary').removeClass('btn-outline-secondary');
    setTimeout(() => {
      $(this).removeClass('btn-secondary').addClass('btn-outline-secondary');
    }, 200);
  });
  
  // Botón exportar (ahora funcional)
  $('#btn-exportar-csv').on('click', function() {
    // Obtener fecha y hora actual para el nombre del archivo
    const now = new Date();
    const pad = n => n.toString().padStart(2, '0');
    const fechaStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
    const nombreArchivo = `transferencias_filtradas_${fechaStr}.csv`;

    // Seleccionar solo las filas visibles
    const filas = $('#tabla-transferencias tbody tr:visible').not('#mensaje-no-coincidencias');
    if (filas.length === 0) {
      toastr.warning('No hay transferencias para exportar.');
      return;
    }

    // Encabezados
    const headers = [
      'Cliente', 'Monto', 'Empresa', 'RUT', 'Fecha', 'Fecha Detec', 'Estado Asignación'
    ];
    let csv = '\uFEFF' + headers.join(',') + '\n'; // BOM UTF-8

    // Recorrer filas visibles y extraer datos
    filas.each(function() {
      const tds = $(this).find('td');
      const cliente = $(tds[0]).text().replace(/\s+/g, ' ').trim();
      const monto = $(tds[1]).text().replace(/\s+/g, '').replace(/\./g, '').replace(/\u00a0/g, '').replace(/\$/g, '').replace(/,/g, '');
      const empresa = $(tds[2]).text().replace(/\s+/g, ' ').trim();
      const rut = $(tds[3]).text().replace(/\s+/g, '').trim();
      const fecha = $(tds[4]).text().replace(/\s+/g, ' ').trim();
      const fechaDetec = $(tds[5]).text().replace(/\s+/g, ' ').trim();
      // Estado asignación
      const asignado = $(this).data('asignado') === 'asignado' ? 'Asignada' : 'No asignada';
      // Construir línea CSV
      const row = [cliente, monto, empresa, rut, fecha, fechaDetec, asignado].map(v => '"' + v.replace(/"/g, '""') + '"').join(',');
      csv += row + '\n';
    });

    // Descargar el archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (navigator.msSaveBlob) { // IE 10+
      navigator.msSaveBlob(blob, nombreArchivo);
    } else {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', nombreArchivo);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    // Feedback visual
    $(this).addClass('btn-success').removeClass('btn-outline-success');
    $(this).html('<i class="fas fa-check"></i> Exportado');
    setTimeout(() => {
      $(this).removeClass('btn-success').addClass('btn-outline-success');
      $(this).html('<i class="fas fa-file-excel me-1"></i>Exportar');
    }, 1200);
  });
  
  // Inicializar filtros
  aplicarFiltrosTiempoReal();

  // Abrir modal de ocultar empresas
  $('#btn-ocultar-empresas').on('click', function() {
    $('#modalEmpresas').modal('show');
  });

  // Guardar empresas a ocultar y aplicar filtro
  let empresasOcultas = [];
  $('#btn-aplicar-ocultar-empresas').on('click', function() {
    empresasOcultas = [];
    $('.chk-empresa-ocultar:checked').each(function() {
      empresasOcultas.push($(this).val().toLowerCase());
    });
    $('#modalEmpresas').modal('hide');
    aplicarFiltrosTiempoReal();
  });
});
</script>

<style>
  .table-striped > tbody > tr:nth-of-type(odd) {
    background-color: #f8f9fa;
  }
  .table-striped > tbody > tr:nth-of-type(even) {
    background-color: #f3f6fa;
  }
  .table-striped > tbody > tr:hover {
    background-color: #e3f0ff !important;
    transition: background 0.2s;
  }
  .resaltado-animado {
    animation: highlight-row 0.6s ease-in-out;
    background-color: #ffe082 !important;
  }
  @keyframes highlight-row {
    0% { background-color: #fffde7; }
    50% { background-color: #ffe082; }
    100% { background-color: #ffe082; }
  }
  .table th, .table td {
    vertical-align: middle;
    padding-top: 0.45rem;
    padding-bottom: 0.45rem;
  }
  .sticky-header th {
    position: sticky;
    top: 0;
    background: #0a2c53;
    color: #fff;
    z-index: 2;
  }
  .text-end {
    text-align: right !important;
  }
  
  /* Animaciones para filtros */
  .card {
    transition: all 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
  }
  
  /* Efectos visuales para botones */
  .btn {
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    transform: translateY(-1px);
  }
  
  /* Resaltado de búsqueda */
  mark {
    animation: highlight 0.3s ease-in-out;
  }
  
  @keyframes highlight {
    0% { background-color: #fff3cd; }
    100% { background-color: #ffeb3b; }
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .card-body {
      padding: 1rem;
    }
    
    .row.g-3 > div {
      margin-bottom: 1rem;
    }
  }
</style>
{% endblock %}